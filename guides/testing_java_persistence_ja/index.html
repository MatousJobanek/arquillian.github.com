<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Testing Java Persistence &#183; Arquillian Guides</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="データをテストしよう！Arquillianのテストで、複数のプロバイダについてどのようにJava Persistence (JPA) クエリをテストするかを学びます。" name="description" />
    <link href="/blog/atom.xml" rel="alternate" title="Arquillian blog Atom feed" type="application/atom+xml" />
    <link href="/stylesheets/screen.css?0fd0a1c2677d9b182484f638c62872880d576e68" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.js"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="shortcut icon" />
  </head>
  <body class="guide">
    <header class="navbar navbar-fixed-top" id="banner" role="banner">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <div class="g-plusone-slot">
            <div class="g-plusone" data-annotation="none"></div>
          </div>
          <a class="brand" href="/">
            <span class="logo"></span>
            <span class="name">Arquillian</span>
          </a>
          <nav class="nav-collapse" role="navigation">
            <ul class="nav">
              <li><a href="/invasion/">Invasion!</a></li>
              <li><a href="/features/">Features</a></li>
              <li class="active"><a href="/guides/">Guides</a></li>
              <li><a href="/docs/">Docs</a></li>
              <li><a href="/blog/">Blog</a></li>
              <li><a href="/community/">Community</a></li>
              <li><a href="/modules/">Modules</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <div id="main" role="main">
      <div id="content-header">
        <div class="container">
          <div class="headline">
            <h1>
              <a href="/guides/">Arquillian Guides</a>
              <small>Designed exclusively to teach you how to use Arquillian to write real tests.</small>
            </h1>
            <div class="directory">
              <a class="guides_menu" href="./" id="guides_menu">
                Guides Index
                <i class="icon-menu-closed"></i>
              </a>
              <div id="guides" style="display: none">
                <a class="guides_menu" href="./">
                  Guides Index
                  <i class="icon-menu-open"></i>
                </a>
                <hr class="clear" />
                <dl class="beg">
                  <dt>First Steps</dt>
                  <dd><a href="/guides/getting_started/">Getting Started</a>
                  <br />
                  <a href="/guides/getting_started/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/getting_started_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/getting_started_el_gr/"><img class="flag" rel="tooltip" src="/images/flags/el_gr.png" title="Ελληνικά (el_gr)" /></a>
                  <a href="/guides/getting_started_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/getting_started_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/getting_started_it/"><img class="flag" rel="tooltip" src="/images/flags/it.png" title="Italiano (it)" /></a>
                  <a href="/guides/getting_started_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/getting_started_nl/"><img class="flag" rel="tooltip" src="/images/flags/nl.png" title="Nederlands (nl)" /></a>
                  <a href="/guides/getting_started_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/getting_started_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/getting_started_sk/"><img class="flag" rel="tooltip" src="/images/flags/sk.png" title="Slovenčina (sk)" /></a>
                  <a href="/guides/getting_started_sv_se/"><img class="flag" rel="tooltip" src="/images/flags/sv_se.png" title="Svenska (sv_se)" /></a>
                  <a href="/guides/getting_started_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/getting_started_rinse_and_repeat/">Getting Started: Rinse and Repeat</a>
                  <br />
                  <a href="/guides/getting_started_rinse_and_repeat/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_it/"><img class="flag" rel="tooltip" src="/images/flags/it.png" title="Italiano (it)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/get_started_faster_with_forge/">Get Started Faster with Forge</a></dd>
                  <dd><a href="/guides/shrinkwrap_introduction/">Creating Deployable Archives with ShrinkWrap</a>
                  <br />
                  <a href="/guides/shrinkwrap_introduction/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/shrinkwrap_introduction_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/shrinkwrap_introduction_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/shrinkwrap_introduction_it/"><img class="flag" rel="tooltip" src="/images/flags/it.png" title="Italiano (it)" /></a>
                  <a href="/guides/shrinkwrap_introduction_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/shrinkwrap_introduction_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/shrinkwrap_introduction_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/shrinkwrap_introduction_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                </dl>
                <dl class="int">
                  <dt>More Coverage</dt>
                  <dd><a href="/guides/testing_java_persistence/">Testing Java Persistence</a>
                  <br />
                  <a href="/guides/testing_java_persistence/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/testing_java_persistence_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/testing_java_persistence_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/testing_java_persistence_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/testing_java_persistence_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/testing_java_persistence_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/functional_testing_using_graphene/">Functional Testing using Drone and Graphene</a></dd>
                  <dd><a href="/guides/testing_in_the_cloud/">Testing in the Cloud</a></dd>
                </dl>
                <dl class="adv">
                  <dt>Enhance</dt>
                  <dd><a href="/guides/developing_a_container_adapter/">Developing a Container Adapter</a></dd>
                </dl>
                <dl class="ref">
                  <dt>Reference</dt>
                  <dd><a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Reference Guide</a></dd>
                  <dd><a href="http://docs.jboss.org/arquillian/aggregate/latest">API &amp; SPI Docs</a></dd>
                  <dd><a href="http://community.jboss.org/wiki/ArquillianMigrationGuides">Migration Guides</a></dd>
                  <dd><a href="http://community.jboss.org/en/arquillian/faq">FAQs</a></dd>
                </dl>
              </div>
            </div>
            <script>$(function() { activateGuideMenuControl() })</script>
          </div>
        </div>
      </div>
      <div class="container" id="guide">
        <div id="content" lang="ja">
            <div class="header">
            <div class="titlebar">
            <h2>Testing Java Persistence</h2>
            <div class="btn-group">
              <a class="btn" href="https://github.com/arquillian/arquillian.github.io/edit/develop/guides/testing_java_persistence_ja.textile">Edit this file</a>
            </div>
          </div>
            <div class="authors"><strong>Authors:</strong>
          <a href="/community/mojavelinux">Dan Allen</a>, <a href="/community/bartoszmajsak">Bartosz Majsak</a>, <a href="/community/hasalex">Alexis Hassler</a>  <br />
          <strong style="padding-left: 0px;">Tags:</strong>
          jpa, database, persistence, transactions  <strong style="padding-left: 10px;">Last Update:</strong>Oct 14, 2012</div>
            <p>このガイドでは、Java Persistence (JPA) データレイヤをテストするためのArquillianの使い方を説明します。このガイドを読んだら、以下のことができるようになります：</p>
            <ul>
          	<li>JPA記述子(persistence.xml)を含むテストアーカイブを作成する</li>
          	<li>EntityManagerとUserTransactionをテストにインジェクトする</li>
          	<li>エンティティを永続化し、JPQLとJPA2のクライテリアAPIで問い合わせてそれを取得する</li>
          	<li>異なるJPAプロバイダを使用してテストを実行する</li>
          </ul>
            <p>JPAをテストするための、あるいはそれがどのように動作するかシンプルに実験するための完璧な方策を、Arquillianが提供することにすぐに気づくでしょう。このガイドは、JPAに立ち向かう必要があるときにはいつでも戻ってこれるよう、簡単にフォローできるようにデザインされています。</p>
            </div>
            <h3 id="&#21069;&#25552;">前提</h3>
          <p><a href="/guides/getting_started">Getting Started</a> ガイドか <a href="/guides/get_started_faster_with_forge">Get Started Faster with Forge</a> ガイドのどちらかを読んでいて、MavenプロジェクトでArquillianテストスイートをセットアップしていることを前提としています。新しくレッスンを始めるために、既存のJavaクラスを削除してください。基本的なJavaパーシスタンステスト（JPA）を作成するため、プロジェクトにJPAエンティティを追加します。そこから、あなたがテストを必要とする他のエンティティにこれらの説明を適用できるようになります。</p>
          <p>このガイドの説明はMavenプロジェクトに特化していますが、ArquillianはまったくMavenに依存していないことは覚えておいてください。テストは、Embedded GlassFishとローカルにあるJBoss AS 7のインスタンスでテストを実行します。JPAを提供し、Arquillianがサポートしている、他のコンテナを使うこともできます。</p>
          <p class="warning"><span>WeldはJPAサービスを提供していないため、このチュートリアルでは、arquillian-weld-ee-embeddedプロファイルは使用できません（WeldはCDIだけを提供しています）。</span></p>
          <h3 id="&#30446;&#30340;">目的</h3>
          <p>このアプリケーションには（ビデオ） <code>Game</code> エンティティがあり、2つのフィールドを含みます：</p>
          <ul>
          	<li><code>id</code> &#8211; プライマリキー</li>
          	<li><code>title</code> &#8211; ゲームタイトル</li>
          </ul>
          <p>サンプルエンティティをデータベースに永続化し、JPQLとJPA 2のクライテリアAPIを使ってそれらを読み込むテストを書こうとしています。完成したら、テストは以下の3タスクを実行します：</p>
          <ul>
          	<li>JPA <code>エンティティマネージャー</code> を使ってサンプルエンティティをデータベースに保存する</li>
          	<li>JPQLを使ってデータベースに問い合わせる</li>
          	<li>JPA 2 クライテリアAPIを使ってデータベースに問い合わせる</li>
          </ul>
          <p>ソースコード全体は、githubの <a href="http://github.com/arquillian/arquillian-examples/tree/master/arquillian-persistence-tutorial">Arquillian examples project</a> で取得できます。動作の確認には、以下のコマンドを実行するだけです（そしてMavenの依存コンポーネントダウンロードをちょっと待ちます）。</p>
          <pre class="command"><code class="command">mvn test</code></pre>
          <p>どのように動作するか、掘り下げてみましょう。</p>
          <h3 id="&#12503;&#12525;&#12472;&#12455;&#12463;&#12488;&#27083;&#25104;">プロジェクト構成</h3>
          <p>まず初めに、以下がこのプロジェクトのディレクトリ構成です：</p>
          <ul class="filetree">
          	<li>src/
          	<ul>
          		<li>main/
          		<ul>
          			<li>java/
          			<ul>
          				<li>org/
          				<ul>
          					<li>arquillian/
          					<ul>
          						<li>example/
          						<ul>
          							<li>Game.java</li>
          						</ul></li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          			<li>resources/
          			<ul>
          				<li>META-INF/
          				<ul>
          					<li>persistence.xml</li>
          				</ul></li>
          			</ul></li>
          		</ul></li>
          		<li>test/
          		<ul>
          			<li>java/
          			<ul>
          				<li>org/
          				<ul>
          					<li>arquillian/
          					<ul>
          						<li>example/
          						<ul>
          							<li>GamePersistenceTest.java</li>
          						</ul></li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          			<li>resources/
          			<ul>
          				<li>arquillian.xml</li>
          			</ul></li>
          			<li>resources-glassfish-embedded/
          			<ul>
          				<li>glassfish-resources.xml</li>
          				<li>logging.properties</li>
          				<li>test-persistence.xml</li>
          			</ul></li>
          			<li>resources-jbossas-managed/
          			<ul>
          				<li>test-persistence.xml</li>
          			</ul></li>
          		</ul></li>
          	</ul></li>
          	<li>pom.xml</li>
          </ul>
          <p><code>Game</code> はJPAエンティティクラスで、test-persistence.xmlは編集を加えたpersistence.xmlで、テスト環境のパーシスタンスユニットを定義します。test-persistence.xmlを含む二つのテストフォルダがあることに注意してください。これらはそれぞれのコンテナで使用します。コンテナがどのように選択されるかは後述します。</p>
          <p>テストのための異なるデータソースを使用し、永続化プロバイダをプロダクションとは異なる設定とするため、ベストプラクティスとして、テスト専用のJPAデスクリプタの使用をお勧めします。例えば、テスト環境では、データソースのスキーマを管理するために &#8220;drop-and-create-tables&#8221; ストラテジを使いたいかもしれません。また、データベースクエリをログの出力として見たいかもしれません。これらの設定は、以下で見るようにメインのアプリケーションに影響を与えることなくtest-persistence.xmlで有効化されています。メインのpersistence.xmlには、プロダクションのための定義があるので、触れません。</p>
          <p>以下は、 <code>@Entity</code> アノテーションで示されるように <code>Game</code> エンティティのソースです：</p>
          <div class="filename">src/main/resources/org/arquillian/example/Game.java</div>
          <pre class="prettify"><code class="prettify">package org.arquillian.example;</code>&#x000A; &#x000A;<code class="prettify">import java.io.Serializable;&#x000A;import javax.persistence.Entity;&#x000A;import javax.persistence.GeneratedValue;&#x000A;import javax.persistence.Id;&#x000A;import javax.validation.constraints.NotNull;&#x000A;import javax.validation.constraints.Size;</code>&#x000A; &#x000A;<code class="prettify">@Entity&#x000A;public class Game implements Serializable {&#x000A;    private Long id;&#x000A;    private String title;</code>&#x000A; &#x000A;<code class="prettify">    public Game() {}</code>&#x000A; &#x000A;<code class="prettify">    public Game(String title) {&#x000A;        this.title = title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @Id @GeneratedValue&#x000A;    public Long getId() {&#x000A;        return id;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    public void setId(Long id) {&#x000A;        this.id = id;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @NotNull&#x000A;    @Size(min = 3, max = 50)&#x000A;    public String getTitle() {&#x000A;        return title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    public void setTitle(String title) {&#x000A;        this.title = title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @Override&#x000A;    public String toString() {&#x000A;        return "Game@" + hashCode() + "[id = " + id + "; title = " + title + "]";&#x000A;    }&#x000A;}</code></pre>
          <p>プライマリキーは、フィールドに <code>@Id</code> アノテーション で定義されています。その他のカラムは（通常のgetter／setterによる）beanプロパティから生成されます。カラムの名前を厳密に指定するために <code>@Column</code> アノテーションを使うこともできます。一方で、カラム名は、beanプロパティのgetterからget接頭辞を除き、残った部分の最初の文字を小文字にしたものとなります（ 例　getTitle() &rarr; title）。Otherwise, the column name is determined by removing the &#8220;get&#8221; prefix from the bean property&#8217;s read method and lowercasing the first character of the remainder (e.g., getTitle() &rarr; title).</p>
          <p>また、制約を強制するため、標準の Bean Validation アノテーションを使用します。ここで、タイトルの文字数は3から50文字の間とします。（ヒント：これはまた別のよいテストになります）。</p>
          <h3 id="&#12486;&#12473;&#12488;&#12434;&#26360;&#12367;">テストを書く</h3>
          <p>テストについては、JUnit 4 と Arquillian の新しいテストケース、 <code>GamePersistenceTest</code> を作成し、JPA操作のテストのために準備しましょう。 <a href="http://docs.jboss.org/cdi/spec/1.0/html" title="JSR-299">CDI</a> を利用して、依存性注入により必要なリソースを取得します。（あるいは、トランザクション境界を扱うために、EJBを使うこともできます。あとでこれについて触れます）。</p>
          <div class="filename">src/test/java/org/arquillian/example/GamePersistenceTest.java</div>
          <pre class="prettify"><code class="prettify">package org.arquillian.example;</code>&#x000A;&#x000A;<code class="prettify">import java.util.List;&#x000A;import javax.inject.Inject;&#x000A;import javax.persistence.EntityManager;&#x000A;import javax.persistence.PersistenceContext;&#x000A;import javax.transaction.UserTransaction;&#x000A;import org.jboss.arquillian.container.test.api.Deployment;&#x000A;import org.jboss.arquillian.junit.Arquillian;&#x000A;import org.jboss.shrinkwrap.api.Archive;&#x000A;import org.jboss.shrinkwrap.api.ShrinkWrap;&#x000A;import org.jboss.shrinkwrap.api.asset.EmptyAsset;&#x000A;import org.jboss.shrinkwrap.api.spec.WebArchive;&#x000A;import org.junit.runner.RunWith;</code>&#x000A;&#x000A;<code class="prettify">@RunWith(Arquillian.class)&#x000A;public class GamePersistenceTest {&#x000A;    @Deployment&#x000A;    public static Archive&lt;?&gt; createDeployment() {&#x000A;        return ShrinkWrap.create(WebArchive.class, "test.war")&#x000A;            .addPackage(Game.class.getPackage())&#x000A;            .addAsResource("test-persistence.xml", "META-INF/persistence.xml")&#x000A;            .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    private static final String[] GAME_TITLES = {&#x000A;        "Super Mario Brothers",&#x000A;        "Mario Kart",&#x000A;        "F-Zero"&#x000A;    };</code>&#x000A;    &#x000A;<code class="prettify">    @PersistenceContext&#x000A;    EntityManager em;</code>&#x000A;    &#x000A;<code class="prettify">    @Inject&#x000A;    UserTransaction utx;</code>&#x000A; &#x000A;<code class="prettify">    // テストはここから&#x000A;}</code></pre>
          <p>テストに入る前に、ここで何が起きているか理解するために、上から下まで見てみましょう。</p>
          <dl>
          	<dt>@RunWith(Arquillian.class)</dt>
          	<dd>JUnitに、テストの実行をArquillianランナーに移譲するよう示します。これによりArquillianはテストにコンポーネントモデルを提供できます。すなわち、コンテナのライフサイクル管理や依存性注入、その他の拡張などです。基底クラスの継承が不要で、他の目的のために遺されていることに注意してください。</dd>
          	<dt>@Deployment メソッド</dt>
          	<dd><a href="http://jboss.org/shrinkwrap">ShrinkWrap</a> を使って&quot;マイクロデプロイメント&quot; アーカイブをビルドし、返します。Arquillian はテストケースと追加のインフラストラクチャを加えて、このアーカイブをコンテナにデプロイします。そして、テストは、この小さなアプリケーションのコンポーネントとして実行されます。このアーカイブの内容は、テストのための独立した世界として構成されます。</dd>
          	<dt>GAME_TITLES 定数</dt>
          	<dd>テスト用サンプルデータ</dd>
          	<dt>@PersistenceContext EntityManager</dt>
          	<dd><a href="http://download.oracle.com/javaee/6/api/javax/annotation/ManagedBean.html">managed bean</a> であるテストに直接、永続化コンテキスト（ つまり <code>EntityManager</code> ）をインジェクトします。</dd>
          	<dt>@Inject UserTransaction</dt>
          	<dd>JTAトランザクションを直接テストにインジェクトします。テストはCDI (JSR-299)により、マネージドbeanとして提供されています。</dd>
          </dl>
          <p>テストロジックがパーシスタンス関連のセットアップと混ざらないように、テスト実行の前後に実行されるインターセプトメソッドを導入しましょう。この横断的なコードを見てみましょう。</p>
          <p><code>@Before</code> メソッドはそれぞれのテストの前に実行され、以下のタスクを行います：</p>
          <ol>
          	<li>データベースの状態をクリーンにし、以前のテスト実行によるデータの残存を防ぎます</li>
          	<li>テストに必要なサンプルデータをインサートします</li>
          	<li>トランザクションを開始します</li>
          </ol>
          <p>一つのimport文を含む以下のメソッドをテストケースに追加します：</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import org.junit.Before;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Before&#x000A;public void preparePersistenceTest() throws Exception {&#x000A;    clearData();&#x000A;    insertData();&#x000A;    startTransaction();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void clearData() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;    System.out.println("Dumping old records...");&#x000A;    em.createQuery("delete from Game").executeUpdate();&#x000A;    utx.commit();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void insertData() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;    System.out.println("Inserting records...");&#x000A;    for (String title : GAME_TITLES) {&#x000A;        Game game = new Game(title);&#x000A;        em.persist(game);&#x000A;    }&#x000A;    utx.commit();&#x000A;    // clear the persistence context (first-level cache)&#x000A;    em.clear();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void startTransaction() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;}</code></pre>
          <p>また、それぞれのテストの後で、トランザクションをコミットするメソッドが必要で、同じように以下のimportが必要です：</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import org.junit.After;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@After&#x000A;public void commitTransaction() throws Exception {&#x000A;    utx.commit();&#x000A;}</code></pre>
          <p>Arquillian はそれぞれのテストの前後に <code>@Before</code> と <code>@After</code> メソッドをコンテナで実行します。 <code>@Before</code> メソッドはインジェクションが行われてから実行されます。</p>
          <p><code>EntityManager</code> がJTAトランザクションに確実にエンリストしなければならないことに注意してください。これは二つのリソースを独立して使用するために必要なステップです。EJB内部ではエンリストは自動的に行われるので、EJBからJPAを利用することに慣れていると上記のコードは正常ではないように見えるかもしれません。</p>
          <h4>JPQLによる問い合わせ</h4>
          <p>以下は、JPQLを使ってサンプルのレコードを取得できることを検証するテストです。何が起きているか確認できるよう、ログステートメントを出力しています。</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import java.util.List;&#x000A;import org.junit.Test;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Test&#x000A;public void shouldFindAllGamesUsingJpqlQuery() throws Exception {&#x000A;    // given&#x000A;    String fetchingAllGamesInJpql = "select g from Game g order by g.id";</code>&#x000A;&#x000A;<code class="prettify">    // when&#x000A;    System.out.println("Selecting (using JPQL)...");&#x000A;    List&lt;Game&gt; games = em.createQuery(fetchingAllGamesInJpql, Game.class).getResultList();</code>&#x000A;&#x000A;<code class="prettify">    // then&#x000A;    System.out.println("Found " + games.size() + " games (using JPQL):");&#x000A;    assertContainsAllGames(games);&#x000A;}</code></pre>
          <p>このテストは、 <code>assertContainsAllGames</code> を呼び出して終わります。これは、独自のアサーションメソッドで、返されたコレクションに、データベースに保存されたタイトルがすべて含まれているか検証します。</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import java.util.Arrays;&#x000A;import java.util.Collection;&#x000A;import java.util.HashSet;&#x000A;import java.util.Set;&#x000A;import org.junit.Assert;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">private static void assertContainsAllGames(Collection&lt;Game&gt; retrievedGames) {&#x000A;    Assert.assertEquals(GAME_TITLES.length, retrievedGames.size());&#x000A;    final Set&lt;String&gt; retrievedGameTitles = new HashSet&lt;String&gt;();&#x000A;    for (Game game : retrievedGames) {&#x000A;        System.out.println("* " + game);&#x000A;        retrievedGameTitles.add(game.getTitle());&#x000A;    }&#x000A;    Assert.assertTrue(retrievedGameTitles.containsAll(Arrays.asList(GAME_TITLES)));&#x000A;}</code></pre>
          <p>アサーションのための独立したメソッドには二つの利点があります：</p>
          <ul>
          	<li>我々が何を期待しているか、明確に説明する</li>
          	<li>他のテストで再利用できる</li>
          </ul>
          <p>さてつぎは、JPA 2の新しい機能である、クライテリアAPIです！</p>
          <h4>JPA 2 メタモデルの生成</h4>
          <p>クライテリアAPIを使う場合、すべてを「型安全」に保つために、理想的にはJPA 2 メタモデルクラスを参照したいです。これらのクラスをMavenで生成するには、MavenにJDK6を使ってよいと指示する必要があります（これは次のように扱いが面倒です）。</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;build&gt;&#x000A;    &lt;plugins&gt;&#x000A;        &lt;plugin&gt;&#x000A;            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;&#x000A;            &lt;version&gt;2.3.2&lt;/version&gt;&#x000A;            &lt;configuration&gt;&#x000A;                &lt;source&gt;1.6&lt;/source&gt;&#x000A;                &lt;target&gt;1.6&lt;/target&gt;&#x000A;            &lt;/configuration&gt;&#x000A;        &lt;/plugin&gt;&#x000A;    &lt;/plugins&gt;&#x000A;&lt;/build&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p>また、Mavenに、JPA 2 アノテーションプロセッサを実行するよう設定が必要で、コンパイル用のプロジェクトの依存性として、Hibernate JPAメタモデルジェネレータを追加するだけです：</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;dependency&gt;&#x000A;    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;&#x000A;    &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;&#x000A;    &lt;version&gt;1.2.0.Final&lt;/version&gt;&#x000A;    &lt;scope&gt;provided&lt;/scope&gt;&#x000A;&lt;/dependency&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p class="info"><span>このメタモデルのジェネレーターは、JDK 6のコンパイラを使っていて、アノテーションプロセッサのJARがクラスパスにあれば自動的に実行されます。</span></p>
          <p>EclipseでJPA 2 のメタモデルを生成するのは、もう少しトリッキーです。プロジェクトのトップレベルへの.factorypathというファイルの作成と、以下の設定の追加から始めます：</p>
          <div class="filename">.factorypath</div>
          <pre class="prettify"><code class="prettify">&lt;factorypath&gt;&#x000A;    &lt;factorypathentry kind="VARJAR" enabled="true" runInBatchMode="false"&#x000A;        id="M2_REPO/org/hibernate/hibernate-jpamodelgen/1.2.0.Final/hibernate-jpamodelgen-1.2.0.Final.jar"/&gt;&#x000A;    &lt;factorypathentry kind="VARJAR" enabled="true" runInBatchMode="false"&#x000A;        id="M2_REPO/org/hibernate/javax/persistence/hibernate-jpa-2.0-api/1.0.0.Final/hibernate-jpa-2.0-api-1.0.0.Final.jar"/&gt;&#x000A;&lt;/factorypath&gt;</code></pre>
          <p>次に、プロジェクト上で右クリックして、プロパティを選択します。設定ツリーで、Java Compilerのノードを展開し、Annotation Processingを選択します。以下の値を変更してください：</p>
          <ul>
          	<li>&#8220;Enable project specific settings* チェックボックスをチェック</li>
          	<li>&#8220;Enable annotation processing&#8221; チェックボックスをチェック</li>
          	<li>&#8220;Generated source directory&#8221; に(引用符なしで) &#8220;target/generated-sources/annotations&#8221; と設定</li>
          	<li>Apply ボタンをクリックし、フルビルドを承認</li>
          	<li>&#8220;Enable annotation processing&#8221; のチェックを外す</li>
          	<li>Apply ボタンをクリックし、フルビルドをスキップ</li>
          	<li>&#8220;Enable project specific settings* チェックボックスをチェック</li>
          	<li>Apply ボタンをクリックし、フルビルドを承認</li>
          </ul>
          <p>これで、target/generated-sources/annotations以下に <code>Game_.java</code> が確認できるはずです。また、これは、ビルドパスに含まれるはずです。</p>
          <p class="info"><span>ええ、スナックをスナック自販機から落とすときに蹴飛ばす必要があるように、少々いじりまわす必要があります ~:) これが大変だったら、メタモデルの生成は飛ばして、単純にカラム名を文字列で参照することもできます。</span></p>
          <p>ついに、クライテリアクエリーを書く準備ができました！</p>
          <h4>クライテリアAPIによる問い合わせ</h4>
          <p>以下は、前述のテストをコピーし、クライテリアAPIを使うよう更新したものです。このテストは、コンパイル時に、JPA 2 アノテーションプロセッサが生成した <code>Game_</code> メタモデルクラスに依存することに注意してください。</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import javax.persistence.criteria.CriteriaBuilder;&#x000A;import javax.persistence.criteria.CriteriaQuery;&#x000A;import javax.persistence.criteria.Root;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Test&#x000A;public void shouldFindAllGamesUsingCriteriaApi() throws Exception {&#x000A;    // given&#x000A;    CriteriaBuilder builder = em.getCriteriaBuilder();&#x000A;    CriteriaQuery&lt;Game&gt; criteria = builder.createQuery(Game.class);</code>&#x000A;    		&#x000A;<code class="prettify">    Root&lt;Game&gt; game = criteria.from(Game.class);&#x000A;    criteria.select(game);&#x000A;    // TIP: もしJPA 2メタモデルを使いたくない場合は、&#x000A;    // この get() メソッドコールを get("id") に変更できます&#x000A;    criteria.orderBy(builder.asc(game.get(Game_.id)));&#x000A;    // WHERE句が無いので、すべてのselectを意味します</code>&#x000A;&#x000A;<code class="prettify">    // when&#x000A;    System.out.println("Selecting (using Criteria)...");&#x000A;    List&lt;Game&gt; games = em.createQuery(criteria).getResultList();</code>&#x000A;&#x000A;<code class="prettify">    // then&#x000A;    System.out.println("Found " + games.size() + " games (using Criteria):");&#x000A;    assertContainsAllGames(games);&#x000A;}</code></pre>
          <p>JPAを実行するため、パーシスタンスユニットも必要です。</p>
          <p>ターゲットのコンテナに対応するtest-persistence.xmlに、パーシタンスユニットを定義します。ShrinkWrap はこのファイルをクラスパスから取得し、アーカイブ内の標準位置に配置します。</p>
          <pre class="prettify"><code class="prettify">.addAsResource("test-persistence.xml", "META-INF/persistence.xml")</code></pre>
          <p>以下が、ShrinkWrapがこのテストケースのために組み立てるアーカイブの構成です（Arquillianのインフラストラクチャは省略）：</p>
          <ul class="filetree">
          	<li>WEB-INF/
          	<ul>
          		<li>beans.xml</li>
          		<li>classes/
          		<ul>
          			<li>META-INF/
          			<ul>
          				<li>persistence.xml</li>
          			</ul></li>
          			<li>org/
          			<ul>
          				<li>arquillian/
          				<ul>
          					<li>example/
          					<ul>
          						<li>Game.class</li>
          						<li>GamePersistenceTestCase.class</li>
          						<li>Game_.class</li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          		</ul></li>
          		<li>lib/
          		<ul>
          			<li>*.jar</li>
          		</ul></li>
          	</ul></li>
          </ul>
          <p>テストで使用するパーシスタンスユニットの記述子を、まずEmbedded GlassFishのものから見てみましょう。</p>
          <h3 id="glassfish&#29992;&#12497;&#12540;&#12471;&#12473;&#12479;&#12531;&#12473;&#12398;&#28310;&#20633;">GlassFish用パーシスタンスの準備</h3>
          <p>以下が、Embedded GlassFishで使用するパーシスタンスユニット記述子です：</p>
          <div class="filename">src/test/resources-glassfish-embedded/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="eclipselink.ddl-generation" value="drop-and-create-tables"/&gt;&#x000A;            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;&#x000A;            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>組み込みプロバイダであるEclipseLinkを有効化するため、二つのベンダー依存のプロパティをセットしました：</p>
          <dl>
          	<dt>eclipselink.ddl-generation</dt>
          	<dd>Configures the database schema command. drop-and-create-tablesという値は、テスト実行毎に、EclipseLinkにJPAのエンティティで定義されているようにデータベースを作成するよう指示します。</dd>
          	<dt>eclipselink.logging.level.sql</dt>
          	<dd>Configures query logging. FINE 値はSQLステートメントのロギングを有効にするので、データベースの活動を監視できます。</dd>
          </dl>
          <p>Javaのロギング設定でFINEレベルを有効にするため、EclipseLink ロギングにはこれ以上の設定が必要です。</p>
          <div class="filename">src/test/resources-glassfish-embedded/logging.properties</div>
          <pre class="prettify"><code class="prettify">handlers=java.util.logging.ConsoleHandler&#x000A;java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter&#x000A;java.util.logging.SimpleFormatter.format=%4$s: %5$s%n&#x000A;java.util.logging.ConsoleHandler.level=FINEST</code></pre>
          <p>パーシスタンスユニットは、jdbc/arquillianというデータソースを参照する、test-persistence.xmlです。どこで定義されてるか？ああ、それはArquillianコンテナアダプタが設定しなければなりません。</p>
          <p>JDBCコネクションプールの生成と、リソースの関連付けにGlassFish APIを使いたいです。しかし、それをコーディングしたくはありません。ただ、宣言したいだけです。ここがArquillianの出番です。</p>
          <p>まず、リソース定義を含む glassfish-resources.xml ファイルを作成します。これでGlassFishはどのように使用するか分かります。</p>
          <div class="filename">src/test/resources-glassfish-embedded/glassfish-resources.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;!DOCTYPE resources PUBLIC&#x000A;    "-//GlassFish.org//DTD GlassFish Application Server 3.1 Resource Definitions//EN"&#x000A;    "http://glassfish.org/dtds/glassfish-resources_1_5.dtd"&gt;&#x000A;&lt;resources&gt;&#x000A;    &lt;jdbc-resource pool-name="ArquillianEmbeddedDerbyPool"&#x000A;        jndi-name="jdbc/arquillian"/&gt;&#x000A;    &lt;jdbc-connection-pool name="ArquillianEmbeddedDerbyPool"&#x000A;        res-type="javax.sql.DataSource"&#x000A;        datasource-classname="org.apache.derby.jdbc.EmbeddedDataSource"&#x000A;        is-isolation-level-guaranteed="false"&gt;&#x000A;        &lt;property name="databaseName" value="target/databases/derby"/&gt;&#x000A;        &lt;property name="createDatabase" value="create"/&gt;&#x000A;    &lt;/jdbc-connection-pool&gt;&#x000A;&lt;/resources&gt;</code></pre>
          <p>メインアプリケーションからテストを分離しているように、データソース定義をテストから分離しました。さらによい点は、テストで必要となる、どんなリソースも定義できることです。この可能性を考えてみてください。</p>
          <p>さて、Arquillianにこのファイルを使用するよう伝えます。Arquillian の設定を開始し、このファイルを取得するためにエンベデッドGlassFishコンテナアダプタを設定しました。このファイルはGlassFish管理APIの <code>add-resources</code> コマンドを入力します。</p>
          <div class="filename">src/test/resources/arquillian.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;arquillian xmlns="http://jboss.org/schema/arquillian"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://jboss.org/schema/arquillian&#x000A;        http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;&#x000A;    &lt;container qualifier="glassfish-embedded" default="true"&gt;&#x000A;        &lt;configuration&gt;&#x000A;            &lt;property name="resourcesXml"&gt;&#x000A;                src/test/resources-glassfish-embedded/glassfish-resources.xml&#x000A;            &lt;/property&gt;&#x000A;        &lt;/configuration&gt;&#x000A;    &lt;/container&gt;&#x000A;&lt;/arquillian&gt;</code></pre>
          <p>あるいは、データソースの設定をスキップし、標準のデータベースコネクションプロパティを使ってデータソース接続情報を直接test-persistence.xmlに含めることもできます。</p>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="javax.persistence.jdbc.driver"&#x000A;                value="org.apache.derby.jdbc.EmbeddedDriver"/&gt;&#x000A;            &lt;property name="javax.persistence.jdbc.url"&#x000A;                value="jdbc:derby:target/databases/derby;create=true"/&gt;&#x000A;            &lt;property name="eclipselink.ddl-generation" value="drop-and-create-tables"/&gt;&#x000A;            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;&#x000A;            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>しかし覚えておいてください。JNDIデータソースから明示的なデータベース接続へ変更するということは、プロダクションとテスト環境で、アーキテクチャが変わるということです。したがって、テストが潜在的な失敗をすべて補足しているということについて、信頼性が低くなります。</p>
          <p>残りは、コンテナアダプタの設定とテストの実行です。</p>
          <h3 id="glassfish&#29992;&#12398;&#12486;&#12473;&#12488;&#12434;&#28310;&#20633;&#12377;&#12427;">GlassFish用のテストを準備する</h3>
          <p>Mavenプロファイルを使って、ターゲットコンテナを分離します。（ <a href="/guides/getting_started/">Getting Started</a> ガイドで設定したように）すべてのプロファイルは共通した依存性のセットを共有します。</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;dependencyManagement&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.arquillian&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;arquillian-bom&lt;/artifactId&gt;&#x000A;            &lt;version&gt;1.0.0.Final&lt;/version&gt;&#x000A;            &lt;scope&gt;import&lt;/scope&gt;&#x000A;            &lt;type&gt;pom&lt;/type&gt;&#x000A;        &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;&lt;/dependencyManagement&gt;&#x000A;&lt;dependencies&gt;&#x000A;    &lt;dependency&gt;&#x000A;        &lt;groupId&gt;junit&lt;/groupId&gt;&#x000A;        &lt;artifactId&gt;junit&lt;/artifactId&gt;&#x000A;        &lt;version&gt;4.8.1&lt;/version&gt;&#x000A;    &lt;/dependency&gt;&#x000A;    &lt;dependency&gt;&#x000A;        &lt;groupId&gt;org.jboss.arquillian.junit&lt;/groupId&gt;&#x000A;        &lt;artifactId&gt;arquillian-junit-container&lt;/artifactId&gt;&#x000A;        &lt;scope&gt;test&lt;/scope&gt;&#x000A;    &lt;/dependency&gt;&#x000A;&lt;/dependencies&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p class="warning"><span>MySQLのように、アプリケーションサーバーに同梱されていないデータベースを使うつもりならば、クライアントライブラリもクラスパスに含める必要があります。 <a href="http://github.com/arquillian/arquillian-examples/tree/master/arquillian-persistence-tutorial">sample project</a> を参照してください。このサンプルではDerbyの代わりにH2データベースを使用しています。</span></p>
          <p>さて、Embedded GlassFishのプロファイルを追加（あるいは修正）します：</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;profile&gt;&#x000A;    &lt;id&gt;arquillian-glassfish-embedded&lt;/id&gt;&#x000A;    &lt;activation&gt;&#x000A;        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;&#x000A;    &lt;/activation&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.arquillian.container&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;arquillian-glassfish-embedded-3.1&lt;/artifactId&gt;&#x000A;            &lt;version&gt;1.0.0.CR3&lt;/version&gt;&#x000A;        &lt;/dependency&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.glassfish.main.extras&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;glassfish-embedded-web&lt;/artifactId&gt;&#x000A;            &lt;version&gt;3.1.2&lt;/version&gt;&#x000A;        &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;    &lt;build&gt;&#x000A;        &lt;testResources&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources-glassfish-embedded&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;        &lt;/testResources&gt;&#x000A;        &lt;plugins&gt;&#x000A;            &lt;plugin&gt;&#x000A;                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;&#x000A;                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;&#x000A;                &lt;version&gt;2.12&lt;/version&gt;&#x000A;                &lt;configuration&gt;&#x000A;                    &lt;systemPropertyVariables&gt;&#x000A;                        &lt;java.util.logging.config.file&gt;&#x000A;                            ${project.build.testOutputDirectory}/logging.properties&#x000A;                        &lt;/java.util.logging.config.file&gt;&#x000A;                        &lt;derby.stream.error.file&gt;&#x000A;                            ${project.build.directory}/derby.log&#x000A;                        &lt;/derby.stream.error.file&gt;&#x000A;                    &lt;/systemPropertyVariables&gt;&#x000A;                &lt;/configuration&gt;&#x000A;            &lt;/plugin&gt;&#x000A;        &lt;/plugins&gt;&#x000A;    &lt;/build&gt;&#x000A;&lt;/profile&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p>test-persistence.xmlをクラスパスに置くために、ご覧のように、テストリソースのディレクトリとして、 src/test/resources-glassfish-embedded ディレクトリを加えました。また、Java ログ設定をフォークしたJavaプロセスに渡すために、surefireプラグインを設定しました。これにより、SQLロギングが有効になります。最後に、プロジェクトをクリーンにすると消えてなくなるように、Derbyログファイルの出力場所をビルドの出力ディレクトリにしました。</p>
          <p class="info"><span>他のコンテナでテストする予定がなければ、上記の設定をプロファイルに入れる必要はありません。</span></p>
          <h3 id="glassfish&#12391;&#12486;&#12473;&#12488;&#12434;&#23455;&#34892;&#12377;&#12427;">GlassFishでテストを実行する</h3>
          <p>すべての設定が終わったら、IDEで Run As &gt; Junit Testを選択するか、以下のコマンドを実行することでMavenからテストを実行できます：</p>
          <pre class="command"><code class="command">$ mvn clean test</code></pre>
          <p>（arquillian.xmlでのコンテナアダプタの設定と同じように）Embedded GlassFishのMavenプロファイルは、デフォルトで有効です。テスト実行時出力の一部を以下に示します。</p>
          <pre class="output"><code class="output">...&#x000A;Running org.arquillian.example.GamePersistenceTest&#x000A;...&#x000A;INFO: GlassFish Server Open Source Edition 3.1.2 (java_re-private) ...&#x000A;...&#x000A;INFO: command add-resources result: PlainTextActionReporterSUCCESSDescription: add-resources AdminCommandnull&#x000A;    JDBC connection pool ArquillianEmbeddedDerbyPool created successfully.&#x000A;    JDBC resource jdbc/arquillian created successfully.&#x000A;...&#x000A;INFO: WEB0671: Loading application [test] at [/test]&#x000A;...&#x000A;Dumping old records...&#x000A;FINE: DELETE FROM GAME&#x000A;Inserting records...&#x000A;FINE: UPDATE SEQUENCE SET SEQ_COUNT = SEQ_COUNT + ?WHERE SEQ_NAME = ?   bind =&gt; [50, SEQ_GEN]&#x000A;FINE: SELECT SEQ_COUNT FROM SEQUENCE WHERE SEQ_NAME = ?   bind =&gt; [SEQ_GEN]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [3, F-Zero]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [1, Super Mario Brothers]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [2, Mario Kart]&#x000A;Selecting (using JPQL)...&#x000A;FINE: SELECT ID, TITLE FROM GAME ORDER BY ID ASC&#x000A;Found 3 games (using JPQL):&#x000A;* Game@599290122[id = 1; title = Super Mario Brothers]&#x000A;* Game@1550721071[id = 2; title = Mario Kart]&#x000A;* Game@1107500305[id = 3; title = F-Zero]&#x000A;FINE: DELETE FROM GAME&#x000A;Inserting records...&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [5, Mario Kart]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [6, F-Zero]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [4, Super Mario Brothers]&#x000A;Selecting (using Criteria)...&#x000A;FINE: SELECT ID, TITLE FROM GAME ORDER BY ID ASC&#x000A;Found 3 games (using Criteria):&#x000A;* Game@1020493092[id = 4; title = Super Mario Brothers]&#x000A;* Game@1622992302[id = 5; title = Mario Kart]&#x000A;* Game@294335520[id = 6; title = F-Zero]&#x000A;...</code></pre>
          <p><strong>おめでとう!</strong> <strong class="greenbar">グリーンバー</strong> です！ <em>これは本物の統合テストです！</em></p>
          <p class="important"><span>遅延ローディングやグループフェッチなどの高度なJPAマッピングを導入すると、EclipseLinkが必要なウィービング手順とEmbedded GlassFishが干渉するため、エラーや警告が発生するかもしれません。この問題のワークアラウンドには、追加のビルド設定が必要です。手順については、 <a href="http://blog.eisele.net/2012/01/arquillian-with-netbeans-glassfish_18.html">Markus Eisele&#8217;s blog</a> を参照してください。マネージドまたはリモートコンテナアダプタを使用した場合には、この問題は発生しません。</span></p>
          <h3 id="jboss_as_7&#12391;&#12486;&#12473;&#12488;&#12434;&#23455;&#34892;&#12377;&#12427;">JBoss AS 7でテストを実行する</h3>
          <p>クラスパスをいくつか調整すれば、まったく同じテストをJBoss AS 7上で実行できます。</p>
          <p>最初に、JBoss ASで利用可能なデータソースを指定する、別のパーシスタンスユニット定義が必要です（それとオプションでHibernateの設定をいくつか行っています）。</p>
          <p>JBoss AS 7.0を使っていたら、, you&#8217;d need to <a href="https://docs.jboss.org/author/display/AS7/Admin+Guide#AdminGuide-Datasources">JBoss AS 設定で、手動でデータソースを準備する</a> かビルトインのデータソースである、java:jboss/datasources/ExampleDSを使用する必要があります。以下が、JBoss AS 7.0のビルトインデータソースを使ったパーシスタンスユニット記述子です。</p>
          <div class="filename">src/test/resources-jbossas-managed/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;java:jboss/datasources/ExampleDS&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;&#x000A;            &lt;property name="hibernate.show_sql" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>Hibernate特有のプロパティである、hibernate.hbm2ddl.auto と hibernate.show_sql はEclipseLinkで定義したプロパティと同じ２つの機能を有効にします。</p>
          <p>もしJBoss AS 7.1を使用している場合、これは推奨するバージョンですが、データソース定義を含むデータソース記述子（つまり、-ds.xmlという拡張子を持つファイル）をJavaアーカイブのMETA-INFディレクトリか、WEBアーカイブのWEB-INFディレクトリに追加すると新しいデータソースを動的に登録できます。</p>
          <p>以下が、jdbc/arquillianというJNDI名（GlassFishで前に定義したデータソースと同じJNDI名）でH2 DataSourceを定義した記述子です：</p>
          <div class="filename">src/test/resources/jbossas-ds.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;datasources xmlns="http://www.jboss.org/ironjacamar/schema"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://www.jboss.org/ironjacamar/schema&#x000A;        http://docs.jboss.org/ironjacamar/schema/datasources_1_0.xsd"&gt;&#x000A;    &lt;datasource enabled="true"&#x000A;        jndi-name="jdbc/arquillian"&#x000A;        pool-name="ArquillianEmbeddedH2Pool"&gt;&#x000A;        &lt;connection-url&gt;jdbc:h2:mem:arquillian;DB_CLOSE_DELAY=-1&lt;/connection-url&gt;&#x000A;        &lt;driver&gt;h2&lt;/driver&gt;&#x000A;    &lt;/datasource&gt;&#x000A;&lt;/datasources&gt;</code></pre>
          <p class="info"><span>JBoss AS 7.1は、初期状態でH2 databaseをサポートしています。他のデータベースを使うには、 <a href="https://docs.jboss.org/author/display/AS71/Admin+Guide#AdminGuide-Datasources">DataSources chapter of the JBoss AS 7.1 reference guide</a> で説明してあるように、適切なドライバを追加する必要があります。</span></p>
          <p>新しいデータソースを参照するように、パーシスタンスユニットを更新します：</p>
          <div class="filename">src/test/resources-jbossas-managed/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;&#x000A;            &lt;property name="hibernate.show_sql" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>また、テストアーカイブのWEB-INFディレクトリに記述子を追加します。そして、テストケースの <code>@Deployment</code> メソッド内で、以下のメソッドをShrinkWrapビルダーに追加します：</p>
          <pre class="prettify"><code class="prettify">.addAsWebInfResource("jbossas-ds.xml")</code></pre>
          <p>このファイルをアーカイブに含めても、Embedded GlassFishでのテスト実行には影響しません。データソースとパーシスタンスユニットの準備ができました。</p>
          <p>次に、JBoss ASコンテナアダプタとクラスパス上のJBoss ASリソースフォルダをセットするMavenプロファイルを定義します：</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;profile&gt;&#x000A;    &lt;id&gt;arquillian-jbossas-managed&lt;/id&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;jboss-as-arquillian-container-managed&lt;/artifactId&gt;&#x000A;            &lt;version&gt;7.1.1.Final&lt;/version&gt;&#x000A;            &lt;scope&gt;test&lt;/scope&gt;&#x000A;        &lt;/dependency&gt;&#x000A;         &lt;dependency&gt;&#x000A;             &lt;groupId&gt;org.jboss.spec&lt;/groupId&gt;&#x000A;             &lt;artifactId&gt;jboss-javaee-web-6.0&lt;/artifactId&gt;&#x000A;             &lt;version&gt;3.0.0.Final&lt;/version&gt;&#x000A;             &lt;type&gt;pom&lt;/type&gt;&#x000A;             &lt;scope&gt;provided&lt;/scope&gt;&#x000A;             &lt;exclusions&gt;&#x000A;                 &lt;exclusion&gt;&#x000A;                     &lt;groupId&gt;xalan&lt;/groupId&gt;&#x000A;                     &lt;artifactId&gt;xalan&lt;/artifactId&gt;&#x000A;                 &lt;/exclusion&gt;&#x000A;             &lt;/exclusions&gt;&#x000A;         &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;    &lt;build&gt;&#x000A;        &lt;testResources&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources-jbossas-managed&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;        &lt;/testResources&gt;&#x000A;    &lt;/build&gt;&#x000A;&lt;/profile&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p>Mavenを使ってまたテストを実行します。今回はJBoss ASマネージドプロファイルを有効にします：</p>
          <pre class="command"><code class="command">$ mvn clean test -Parquillian-jbossas-managed</code></pre>
          <p class="warning"><span>JBOSS_HOME 環境変数が JBoss AS 7.1.1.Finalのインストール場所を指すように設定しておいてください。あるいは、arquillian.xmlのjbossHomeプロパティに場所を設定することもできます。</span></p>
          <p>これがキッカーです。または、テストをIDEから実行することもできます！このプロジェクトをインポートして、Mavenの arquillian-jbossas-managed プロファイルを有効にします（そして arquillian-glassfish-embedded プロファイルを無効にします）。テストケースを開いて、最後に &#8220;Run As &gt; JUnit Test&#8221; を選択します。ほら！他のJUnitテストと同じように動作します。 <strong class="greenbar">グリーンバー</strong> です！</p>
          <p><strong>JPAをテストする完璧なレシピを楽しんでください！</strong></p>
          <p class="info"><span>このガイドにはたくさんの設定があるのは、すべてを網羅したからだと考えてください。Arquillianによる利点に気づいてもらうために、テストケースがどれだけシンプルか、見直してみてください。そして、Java EE 6コンテナや、JPA 2の実装に依存しないことを思い出してみてください。</span></p>
          <h3 id="share">Share the Knowledge</h3>
          <p>Find this guide useful?</p>
          <p class="post_to_twitter"><a href="http://twitter.com/home/?status=Just%20read%20the%20%23Arquillian%20Testing%20Java%20Persistence%20guide%20and%20got%20a%20%23greenbar!%20Get%20yours.%20http://arquillian.org/guides/testing_java_persistence_ja/"><img src="/images/post_to_twitter.png" alt="" /></a></p>
          <div class="g-plusone" data-size="tall"></div>
          <p>There&#8217;s a lot more about Arquillian to cover. If you&#8217;re ready to learn more, check out the <a href="/guides">other available guides</a>.</p>
          <h4>Feedback</h4>
          <p>Find a bug in the guide? Something missing? You can fix it by <a href="http://github.com/arquillian/arquillian.github.com">forking this website</a>, making the correction and <a href="http://help.github.com/send-pull-requests">sending a pull request</a>. If you&#8217;re just plain stuck, feel free to ask a question in the <a href="http://community.jboss.org/en/arquillian?view=discussions">user discussion forum</a>.</p>
          <h4>Recent Changelog</h4>
          <ul>
            <li>
              Oct 14, 2012:
              Add japanese translation for testing java persistence guide
              <em>by Takayuki Konishi</em>
            </li>
          </ul>
          <p>
            <a href="https://github.com/arquillian/arquillian.github.io/commits/develop/guides/testing_java_persistence_ja.textile">See full history &raquo;</a>
          </p>
        </div>
        <div id="sidebar">
          <div id="toc">
            <h3 class="chapter_header">Chapters</h3>
            <ol class="chapters">
              <li>
                <a href="#&#21069;&#25552;" id="前提_link">前提</a>
              </li>
              <li>
                <a href="#&#30446;&#30340;" id="目的_link">目的</a>
              </li>
              <li>
                <a href="#&#12503;&#12525;&#12472;&#12455;&#12463;&#12488;&#27083;&#25104;" id="プロジェクト構成_link">プロジェクト構成</a>
              </li>
              <li>
                <a href="#&#12486;&#12473;&#12488;&#12434;&#26360;&#12367;" id="テストを書く_link">テストを書く</a>
              </li>
              <li>
                <a href="#glassfish&#29992;&#12497;&#12540;&#12471;&#12473;&#12479;&#12531;&#12473;&#12398;&#28310;&#20633;" id="glassfish用パーシスタンスの準備_link">GlassFish用パーシスタンスの準備</a>
              </li>
              <li>
                <a href="#glassfish&#29992;&#12398;&#12486;&#12473;&#12488;&#12434;&#28310;&#20633;&#12377;&#12427;" id="glassfish用のテストを準備する_link">GlassFish用のテストを準備する</a>
              </li>
              <li>
                <a href="#glassfish&#12391;&#12486;&#12473;&#12488;&#12434;&#23455;&#34892;&#12377;&#12427;" id="glassfishでテストを実行する_link">GlassFishでテストを実行する</a>
              </li>
              <li>
                <a href="#jboss_as_7&#12391;&#12486;&#12473;&#12488;&#12434;&#23455;&#34892;&#12377;&#12427;" id="jboss_as_7でテストを実行する_link">JBoss AS 7でテストを実行する</a>
              </li>
              <li>
                <a href="#share" id="share_link">Share the Knowledge</a>
              </li>
            </ol>
          </div>
        </div>
        <script>
          $(window).load(function() { activateScrollingToc(['前提', '目的', 'プロジェクト構成', 'テストを書く', 'glassfish用パーシスタンスの準備', 'glassfish用のテストを準備する', 'glassfishでテストを実行する', 'jboss_as_7でテストを実行する', 'share']) })
        </script>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="project">
          <img src="/images/arquillian_logo_200px.png" />
          <p class="bottom">
            &#169;
            Copyright 2009-2017 Red Hat, Inc.
            <br />
            <i class="icon-fire"></i>
            Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.
            <br />
            <i class="icon-share-alt"></i>
            Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
            <br />
            Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>.
          </p>
        </div>
        <div class="footer-nav">
          <h4>Learn</h4>
          <ul>
            <li>
              <a href="/invasion">Mission</a>
            </li>
            <li>
              <a href="/features">Features</a>
            </li>
            <li>
              <a href="/docs">Documentation</a>
            </li>
            <li>
              <a href="/guides">Guides</a>
            </li>
            <li>
              <a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Manual</a>
            </li>
            <li>
              <a href="http://community.jboss.org/en/arquillian/faq">FAQs</a>
            </li>
          </ul>
        </div>
        <div class="footer-nav">
          <h4>Get Involved</h4>
          <ul>
            <li>
              <a href="http://community.jboss.org/en/arquillian?view=discussions">Forums</a>
            </li>
            <li>
              <a href="https://issues.jboss.org/browse/ARQ">Issue Tracker</a>
            </li>
            <li>
              <a href="https://github.com/arquillian">Source Code</a>
            </li>
            <li>
              <a href="/community/contributors">Contributors</a>
            </li>
            <li>
              <a href="https://community.jboss.org/groups/testing">Testing SIG</a>
            </li>
          </ul>
        </div>
        <div class="sponser">
          <div class="follow-us">
            <h4>Stay Informed</h4>
            <ul>
              <li>
                <a href="https://plus.google.com/100660127586085393031?rel=author"><img alt="Google+" src="/images/social/googleplus-16.png" title="Follow Arquillian on Google+" /></a>
              </li>
              <li>
                <a href="https://twitter.com/#!/search/%23arquillian"><img alt="Twitter" src="/images/social/twitter-16.png" title="Browse the #arquillian hashtag on Twitter" /></a>
              </li>
              <li>
                <a href="http://www.linkedin.com/groups?gid=3120340"><img alt="LinkedIn" src="/images/social/linkedin-16.png" title="Join the Arquillian group on LinkedIn" /></a>
              </li>
              <li>
                <a href="http://vimeo.com/channels/arquillian"><img alt="Vimeo" src="/images/social/vimeo-16.png" title="Follow the Arquillian channel on Vimeo" /></a>
              </li>
            </ul>
          </div>
          <p>This website is open source! If you want to improve it, <a href="http://github.com/arquillian/arquillian.github.com">fork the project</a>, hack on it, then send a <a href="https://help.github.com/articles/using-pull-requests">pull request</a>. You can also view the <a href="http://www.seethestats.com/site/arquillian.org">visitor stats</a>.</p>
          <p class="image"><a href="http://jboss.org"><img src="/images/jboss_redhat_branding.png" class="branding" title="Red Hat, Inc." alt="Red Hat, Inc." /></a></p>
          <p>Arquillian is a <a href="http://jboss.org">JBoss Community</a> project and development is sponsored by Red Hat, Inc.</p>
          <p class="bottom"><a href="http://www.redhat.com/legal/legal_statement.html">Terms of Use</a> | <a href="http://www.redhat.com/legal/privacy_statement.html">Privacy Policy</a></p>
        </div>
        <a class="visible-desktop" href="#" id="toTop">Top</a>
      </div>
    </footer>
    <script>
      $(function() {
        $('html').addClass('ready');
        prettify();
        activateFooterGravity();
        activateTooltips();
        activateToTopControl();
      });
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.0.2/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>
    <script src="/javascripts/site.js?36725ae7190fde44ceca06bde916b4bc0c83091d"></script>
    <script src="/javascripts/jquery-scroll.js"></script>
    <script src="http://apis.google.com/js/plusone.js"></script>
    <script>
      (function() {
        var po = document.createElement('script'); po.async = true; po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount','UA-18727998-3']);
    _gaq.push(['_trackPageview']);
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </body>
</html>
