<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Tester la persistance Java &#183; Arquillian Guides</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Testez vos données ! Apprenez comment tester les requêtes JPA sur plusieurs implémentations, avec Arquillian." name="description" />
    <link href="/blog/atom.xml" rel="alternate" title="Arquillian blog Atom feed" type="application/atom+xml" />
    <link href="/stylesheets/screen.css?2685dacf30d367d2e6297e86462db3706390ff4d" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.js"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="shortcut icon" />
  </head>
  <body class="guide">
    <header class="navbar navbar-fixed-top" id="banner" role="banner">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <div class="g-plusone-slot">
            <div class="g-plusone" data-annotation="none"></div>
          </div>
          <a class="brand" href="/">
            <span class="logo"></span>
            <span class="name">Arquillian</span>
          </a>
          <nav class="nav-collapse" role="navigation">
            <ul class="nav">
              <li><a href="/invasion/">Invasion!</a></li>
              <li><a href="/features/">Features</a></li>
              <li class="active"><a href="/guides/">Guides</a></li>
              <li><a href="/docs/">Docs</a></li>
              <li><a href="/blog/">Blog</a></li>
              <li><a href="/community/">Community</a></li>
              <li><a href="/modules/">Modules</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <div id="main" role="main">
      <div id="content-header">
        <div class="container">
          <div class="headline">
            <h1>
              <a href="/guides/">Arquillian Guides</a>
              <small>Designed exclusively to teach you how to use Arquillian to write real tests.</small>
            </h1>
            <div class="directory">
              <a class="guides_menu" href="./" id="guides_menu">
                Guides Index
                <i class="icon-menu-closed"></i>
              </a>
              <div id="guides" style="display: none">
                <a class="guides_menu" href="./">
                  Guides Index
                  <i class="icon-menu-open"></i>
                </a>
                <hr class="clear" />
                <dl class="beg">
                  <dt>First Steps</dt>
                  <dd><a href="/guides/getting_started/">Getting Started</a>
                  <br />
                  <a href="/guides/getting_started/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/getting_started_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/getting_started_el_gr/"><img class="flag" rel="tooltip" src="/images/flags/el_gr.png" title="Ελληνικά (el_gr)" /></a>
                  <a href="/guides/getting_started_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/getting_started_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/getting_started_it/"><img class="flag" rel="tooltip" src="/images/flags/it.png" title="Italiano (it)" /></a>
                  <a href="/guides/getting_started_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/getting_started_nl/"><img class="flag" rel="tooltip" src="/images/flags/nl.png" title="Nederlands (nl)" /></a>
                  <a href="/guides/getting_started_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/getting_started_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/getting_started_sk/"><img class="flag" rel="tooltip" src="/images/flags/sk.png" title="Slovenčina (sk)" /></a>
                  <a href="/guides/getting_started_sv_se/"><img class="flag" rel="tooltip" src="/images/flags/sv_se.png" title="Svenska (sv_se)" /></a>
                  <a href="/guides/getting_started_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/getting_started_rinse_and_repeat/">Getting Started: Rinse and Repeat</a>
                  <br />
                  <a href="/guides/getting_started_rinse_and_repeat/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_it/"><img class="flag" rel="tooltip" src="/images/flags/it.png" title="Italiano (it)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/get_started_faster_with_forge/">Get Started Faster with Forge</a></dd>
                  <dd><a href="/guides/shrinkwrap_introduction/">Creating Deployable Archives with ShrinkWrap</a>
                  <br />
                  <a href="/guides/shrinkwrap_introduction/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/shrinkwrap_introduction_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/shrinkwrap_introduction_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/shrinkwrap_introduction_it/"><img class="flag" rel="tooltip" src="/images/flags/it.png" title="Italiano (it)" /></a>
                  <a href="/guides/shrinkwrap_introduction_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/shrinkwrap_introduction_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/shrinkwrap_introduction_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/shrinkwrap_introduction_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                </dl>
                <dl class="int">
                  <dt>More Coverage</dt>
                  <dd><a href="/guides/testing_java_persistence/">Testing Java Persistence</a>
                  <br />
                  <a href="/guides/testing_java_persistence/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/testing_java_persistence_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/testing_java_persistence_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/testing_java_persistence_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/testing_java_persistence_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/testing_java_persistence_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/functional_testing_using_graphene/">Functional Testing using Drone and Graphene</a></dd>
                  <dd><a href="/guides/testing_in_the_cloud/">Testing in the Cloud</a></dd>
                </dl>
                <dl class="adv">
                  <dt>Enhance</dt>
                  <dd><a href="/guides/developing_a_container_adapter/">Developing a Container Adapter</a></dd>
                </dl>
                <dl class="ref">
                  <dt>Reference</dt>
                  <dd><a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Reference Guide</a></dd>
                  <dd><a href="http://docs.jboss.org/arquillian/aggregate/latest">API &amp; SPI Docs</a></dd>
                  <dd><a href="http://community.jboss.org/wiki/ArquillianMigrationGuides">Migration Guides</a></dd>
                  <dd><a href="http://community.jboss.org/en/arquillian/faq">FAQs</a></dd>
                </dl>
              </div>
            </div>
            <script>$(function() { activateGuideMenuControl() })</script>
          </div>
        </div>
      </div>
      <div class="container" id="guide">
        <div id="content" lang="fr">
            <div class="header">
            <div class="titlebar">
            <h2>Tester la persistance Java</h2>
            <div class="btn-group">
              <a class="btn" href="https://github.com/arquillian/arquillian.github.io/edit/develop/guides/testing_java_persistence_fr.textile">Edit this file</a>
            </div>
          </div>
            <div class="authors"><strong>Authors:</strong>
          <a href="/community/mojavelinux">Dan Allen</a>, <a href="/community/bartoszmajsak">Bartosz Majsak</a>, <a href="/community/hasalex">Alexis Hassler</a>  <strong style="padding-left: 10px;">Translators:</strong>
          <a href="/community/ehsavoie">Emmanuel Hugonnet</a>, <a href="/community/k33g">Philippe Charriere</a>  <strong style="padding-left: 10px;">Language:</strong>
          <img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" />
          <br />
          <strong style="padding-left: 0px;">Tags:</strong>
          jpa, database, persistence, transactions  <strong style="padding-left: 10px;">Last Update:</strong>Mar 22, 2017</div>
            <p>Ce guide vous explique comment utiliser Arquillian pour tester la persistance Java (JPA). Après avoir lu ce guide, vous serez capable de :</p>
            <ul>
          	<li>créer une archive de test, contenant un descripteur JPA (persistence.xml),</li>
          	<li>injecter un <code>EntityManager</code> et un <code>UserTransaction</code> dans votre test,</li>
          	<li>enregistrer des entités puis les interroger via JPQL et l&#8217;API Criteria de JPA 2,</li>
          	<li>exécuter les tests en utilisant différents fournisseurs JPA.</li>
          </ul>
            <p>Vous allez découvrir qu&#8217;Arquillian propose la recette idéale pour tester JPA ou simplement expérimenter comment ça fonctionne. Nous avons conçu ce guide de façon à ce qu&#8217;il soit facile à suivre pour que vous puissiez vous y référer à chaque fois que vous aurez besoin de revenir sur JPA.</p>
            </div>
            <h3 id="hypoth&#232;ses">Hypothèses</h3>
          <p>Nous considérerons que vous avez déjà lu soit le guide <a href="/guides/getting_started_fr">Démarrage Rapide</a>, soit le guide <a href="/guides/get_started_faster_with_forge">Get Started Faster with Forge</a> et que vous avez mis en place une suite de tests Arquillian dans un projet Maven. Nous allons ajouter une entité JPA au projet afin de créer un test élémentaire de persistance Java (JPA). Vous pouvez aussi appliquer ces instructions pour tester vos propres entités.</p>
          <p>Les instructions dans ce guide sont spécifiques à un projet Maven, mais rappelez-vous qu&#8217;Arquillian n&#8217;est en aucune façon lié à Maven. Nous allons exécuter les tests dans un serveur GlassFish embarqué et dans une instance locale de JBoss AS 7, mais vous pouvez utiliser n&#8217;importe quel conteneur supportant JPA supporté par Arquillian.</p>
          <p class="warning"><span>Vous ne pouvez pas utiliser le conteneur arquillian-weld-ee-embedded dans ce tutoriel car Weld ne fournit pas de service JPA (Weld ne fournit que CDI).</span></p>
          <h3 id="objectif">Objectif</h3>
          <p>L&#8217;application a une entité <code>Game</code> (jeux vidéo) avec deux champs :</p>
          <ul>
          	<li><code>id</code> &#8211; la clé primaire</li>
          	<li><code>title</code> &#8211; le titre du jeu</li>
          </ul>
          <p>Nous allons écrire un test qui enregistre des occurrences dans la base de données puis qui les retrouve en utilisant des requêtes JPQL ou l&#8217;API Criteria de JPA 2. Une fois que nous aurons terminé, le test exécutera les trois tâches suivantes :</p>
          <ul>
          	<li>enregistrer des entités dans la base de données en utilisant l&#8217; <code>EntityManager</code> de JPA,</li>
          	<li>interroger la base en utilisant JPQL,</li>
          	<li>interroger la base en utilisant l&#8217;API Criteria de JPA 2.</li>
          </ul>
          <p>Le code source complet est disponible dans le projet <a href="http://github.com/arquillian/arquillian-examples/tree/master/arquillian-persistence-tutorial">d&#8217;exemples Arquillian</a> sur github. Tout ce que vous devrez faire pour le voir en action, c&#8217;est d&#8217;exécuter la commande ci-dessous (et d&#8217;un peu de patience, en attendant que Maven télécharge les dépendances).</p>
          <pre class="command"><code class="command">mvn test</code></pre>
          <h3 id="structure_du_projet">Structure du Projet</h3>
          <p>Afin que vous puissiez prendre vos repères, voici la structure de répertoire du projet :</p>
          <ul class="filetree">
          	<li>src/
          	<ul>
          		<li>main/
          		<ul>
          			<li>java/
          			<ul>
          				<li>org/
          				<ul>
          					<li>arquillian/
          					<ul>
          						<li>example/
          						<ul>
          							<li>Game.java</li>
          						</ul></li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          			<li>resources/
          			<ul>
          				<li>META-INF/
          				<ul>
          					<li>persistence.xml</li>
          				</ul></li>
          			</ul></li>
          		</ul></li>
          		<li>test/
          		<ul>
          			<li>java/
          			<ul>
          				<li>org/
          				<ul>
          					<li>arquillian/
          					<ul>
          						<li>example/
          						<ul>
          							<li>GamePersistenceTest.java</li>
          						</ul></li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          			<li>resources/
          			<ul>
          				<li>arquillian.xml</li>
          			</ul></li>
          			<li>resources-glassfish-embedded/
          			<ul>
          				<li>glassfish-resources.xml</li>
          				<li>logging.properties</li>
          				<li>test-persistence.xml</li>
          			</ul></li>
          			<li>resources-jbossas-managed/
          			<ul>
          				<li>test-persistence.xml</li>
          			</ul></li>
          		</ul></li>
          	</ul></li>
          	<li>pom.xml</li>
          </ul>
          <p><code>Game</code> est l&#8217;entité JPA et test-persistence.xml est une version modifiée de persistence.xml, qui fournit la définition de notre Persistence Unit pour l&#8217;environnement de test. Notez que deux répertoires contiennent un fichier test-persistence.xml, un pour chaque conteneur que nous utiliserons. Nous verrons cela plus tard.</p>
          <p>Nous recommandons d’utiliser un descripteur JPA dédié aux tests, avec une DataSource de test et une configuration spécifique de votre fournisseur de persistance. Par exemple, en environnement de test, vous pourrez vouloir adopter une stratégie “drop-and-create-tables” pour gérer le schéma de la base de données. Vous pouvez aussi vouloir voir les requêtes à la base de données dans la sortie des traces. Ce paramètrage peut être réalisé dans test-persistence.xml sans affecter l’application principale, comme nous le verrons plus loin. Nous laisserons donc de côté le fichier persistence.xml car c’est la configuration pour l’environnement de production.</p>
          <p>Voici le code source de l&#8217;entité <code>Game</code>, annotée en <code>@Entity</code> :</p>
          <div class="filename">src/main/resources/org/arquillian/example/Game.java</div>
          <pre class="prettify"><code class="prettify">package org.arquillian.example;</code>&#x000A; &#x000A;<code class="prettify">import java.io.Serializable;&#x000A;import javax.persistence.Entity;&#x000A;import javax.persistence.GeneratedValue;&#x000A;import javax.persistence.Id;&#x000A;import javax.validation.constraints.NotNull;&#x000A;import javax.validation.constraints.Size;</code>&#x000A; &#x000A;<code class="prettify">@Entity&#x000A;public class Game implements Serializable {&#x000A;    private Long id;&#x000A;    private String title;</code>&#x000A; &#x000A;<code class="prettify">    public Game() {}</code>&#x000A; &#x000A;<code class="prettify">    public Game(String title) {&#x000A;        this.title = title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @Id @GeneratedValue&#x000A;    public Long getId() {&#x000A;        return id;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    public void setId(Long id) {&#x000A;        this.id = id;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @NotNull&#x000A;    @Size(min = 3, max = 50)&#x000A;    public String getTitle() {&#x000A;        return title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    public void setTitle(String title) {&#x000A;        this.title = title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @Override&#x000A;    public String toString() {&#x000A;        return "Game@" + hashCode() + "[id = " + id + "; title = " + title + "]";&#x000A;    }&#x000A;}</code></pre>
          <p>La clé primaire est définie en utilisant l&#8217;annotation <code>@Id</code> sur le champ. Les autres colonnes sont automatiquement déduites des propriétés du bean (avec la convention getter/setter). Vous pouvez utiliser l&#8217;annotation <code>@Column</code> pour modifier explicitement le nom de la colonne. Sinon, le nom de la colonne est défini en retirant le préfixe &#8220;get&#8221; de la méthode de lecture de la propriété du bean et en mettant le premier caractère du reste en minuscule (par exemple, getTitle() &rarr; title).</p>
          <p>Nous pouvons aussi utiliser les annotations standards de Bean Validation pour imposer des contraintes. Ici, le titre est obligatoire et doit avoir entre 3 et 50 caractères.</p>
          <h3 id="ecrire_le_test">Ecrire le Test</h3>
          <p>Ecrivons un nouveau cas de test avec JUnit 4 et Arquillian, <code>GamePersistenceTest</code>, et préparons-le pour tester nos opérations JPA. Nous exploiterons <a href="http://docs.jboss.org/cdi/spec/1.0/html" title="JSR-299">CDI</a> pour qu&#8217;il nous fournisse les ressources dont nous avons besoin via l&#8217;injection de dépendance. (Nous aurions aussi pu utiliser un EJB utilitaire pour gérer les transactions, ce que nous envisagerons dans un guide séparé).</p>
          <div class="filename">src/test/java/org/arquillian/example/GamePersistenceTest.java</div>
          <pre class="prettify"><code class="prettify">package org.arquillian.example;</code>&#x000A;&#x000A;<code class="prettify">import java.util.List;&#x000A;import javax.inject.Inject;&#x000A;import javax.persistence.EntityManager;&#x000A;import javax.persistence.PersistenceContext;&#x000A;import javax.transaction.UserTransaction;&#x000A;import org.jboss.arquillian.container.test.api.Deployment;&#x000A;import org.jboss.arquillian.junit.Arquillian;&#x000A;import org.jboss.shrinkwrap.api.Archive;&#x000A;import org.jboss.shrinkwrap.api.ShrinkWrap;&#x000A;import org.jboss.shrinkwrap.api.asset.EmptyAsset;&#x000A;import org.jboss.shrinkwrap.api.spec.WebArchive;&#x000A;import org.junit.runner.RunWith;</code>&#x000A;&#x000A;<code class="prettify">@RunWith(Arquillian.class)&#x000A;public class GamePersistenceTest {&#x000A;    @Deployment&#x000A;    public static Archive&lt;?&gt; createDeployment() {&#x000A;        return ShrinkWrap.create(WebArchive.class, "test.war")&#x000A;            .addPackage(Game.class.getPackage())&#x000A;            .addAsResource("test-persistence.xml", "META-INF/persistence.xml")&#x000A;            .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    private static final String[] GAME_TITLES = {&#x000A;        "Super Mario Brothers",&#x000A;        "Mario Kart",&#x000A;        "F-Zero"&#x000A;    };</code>&#x000A;    &#x000A;<code class="prettify">    @PersistenceContext&#x000A;    EntityManager em;</code>&#x000A;    &#x000A;<code class="prettify">    @Inject&#x000A;    UserTransaction utx;</code>&#x000A; &#x000A;<code class="prettify">    // tests go here&#x000A;}</code></pre>
          <p>Etudions ce code depuis le début pour comprendre ce qu&#8217;il se passe avant de voir les tests.</p>
          <dl>
          	<dt>@RunWith(Arquillian.class)</dt>
          	<dd>Indique à JUnit de déléguer l&#8217;exécution du test au runner Arquillian. Cela permet à Arquillian d&#8217;enrichir votre test avec un modèle de composant, une gestion de cycle de vie par un conteneur et l&#8217;injection de dépendance, entre autres. Notez que vous n&#8217;avez pas à étendre une classe de base, ce qui vous laisse libre pour d&#8217;autres besoins.</dd>
          	<dt>Méthode @Deployment</dt>
          	<dd>Produit une archive de &#8220;micro-déploiement&#8221; avec l&#8217;API <a href="http://jboss.org/shrinkwrap">ShrinkWrap</a>. Arquillian déploie cette archive dans le conteneur, incluant la classe de test et quelques classes d&#8217;infrastructure. Le test est alors exécuté comme un composant au sein de cette mini-application. Le périmètre de cette archive isole le test du reste du monde.</dd>
          	<dt>Constante GAME_TITLES</dt>
          	<dd>Données de test</dd>
          	<dt>@PersistenceContext EntityManager</dt>
          	<dd>Injecte le contexte de persistance (c-à-d. <code>EntityManager</code>) directement dans le test, comme si le test était un <a href="http://download.oracle.com/javaee/6/api/javax/annotation/ManagedBean.html">managed bean</a>.</dd>
          	<dt>@Inject UserTransaction</dt>
          	<dd>Injecte une transaction JTA directement dans le test, un service fourni au managed bean par CDI (JSR-299).</dd>
          </dl>
          <p>Pour ne pas encombrer notre logique de test avec l&#8217;initialisation de la persistance, nous allons ajouter des méthodes qui seront exécutées avant et après chaque exécution de test. Jetons un coup d&#8217;oeil à ce code.</p>
          <p>La méthode <code>@Before</code>, invoquée avant chaque test; aura les responsabilités suivantes :</p>
          <ol>
          	<li>nettoyer la base de données des résidus des tests précédents,</li>
          	<li>insérer des données qui seront utilisées par nos tests,</li>
          	<li>démarrer une transaction.</li>
          </ol>
          <p>Voici la méthode que vous allez ajouter à votre test, avec une instruction d&#8217;import :</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import org.junit.Before;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Before&#x000A;public void preparePersistenceTest() throws Exception {&#x000A;    clearData();&#x000A;    insertData();&#x000A;    startTransaction();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void clearData() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;    System.out.println("Dumping old records...");&#x000A;    em.createQuery("delete from Game").executeUpdate();&#x000A;    utx.commit();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void insertData() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;    System.out.println("Inserting records...");&#x000A;    for (String title : GAME_TITLES) {&#x000A;        Game game = new Game(title);&#x000A;        em.persist(game);&#x000A;    }&#x000A;    utx.commit();&#x000A;    // clear the persistence context (first-level cache)&#x000A;    em.clear();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void startTransaction() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;}</code></pre>
          <p>Nous aurons aussi besoin d&#8217;une méthode qui valide (commit) la transaction après chaque test, ce qui requiert un autre import :</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import org.junit.After;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@After&#x000A;public void commitTransaction() throws Exception {&#x000A;    utx.commit();&#x000A;}</code></pre>
          <p>Arquillian exécute les méthodes <code>@Before</code> and <code>@After</code> dans le conteneur, respectivement avant et après chaque méthode de test. La méthode <code>@Before</code> est exécutée après que les injections aient été faites.</p>
          <p>Notez que nous devons explicitement joindre l&#8217; <code>EntityManager</code> à la transaction JTA. Cette étape est nécessaire car nous utilisons ces deux ressources indépendamment. Cela peut sembler étrange si vous avez l&#8217;habitude d&#8217;utiliser JPA depuis un EJB, où l&#8217;association est faite automatiquement.</p>
          <h4>Requête JPQL</h4>
          <p>Vous trouverez ici un test qui vérifie qu&#8217;on puisse accéder aux enregistrements en JPQL. Nous avons laissé quelques traces pour mieux suivre ce qui se passe.</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import java.util.List;&#x000A;import org.junit.Test;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Test&#x000A;public void shouldFindAllGamesUsingJpqlQuery() throws Exception {&#x000A;    // given&#x000A;    String fetchingAllGamesInJpql = "select g from Game g order by g.id";</code>&#x000A;&#x000A;<code class="prettify">    // when&#x000A;    System.out.println("Selecting (using JPQL)...");&#x000A;    List&lt;Game&gt; games = em.createQuery(fetchingAllGamesInJpql, Game.class).getResultList();</code>&#x000A;&#x000A;<code class="prettify">    // then&#x000A;    System.out.println("Found " + games.size() + " games (using JPQL):");&#x000A;    assertContainsAllGames(games);&#x000A;}</code></pre>
          <p>Le test se termine par un appel à la méthode <code>assertContainsAllGames</code>. C&#8217;est une assertion personnalisée, qui vérifie que la collection en retour contient tous les titres stockés en base.</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import java.util.Arrays;&#x000A;import java.util.Collection;&#x000A;import java.util.HashSet;&#x000A;import java.util.Set;&#x000A;import org.junit.Assert;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">private static void assertContainsAllGames(Collection&lt;Game&gt; retrievedGames) {&#x000A;    Assert.assertEquals(GAME_TITLES.length, retrievedGames.size());&#x000A;    final Set&lt;String&gt; retrievedGameTitles = new HashSet&lt;String&gt;();&#x000A;    for (Game game : retrievedGames) {&#x000A;        System.out.println("* " + game);&#x000A;        retrievedGameTitles.add(game.getTitle());&#x000A;    }&#x000A;    Assert.assertTrue(retrievedGameTitles.containsAll(Arrays.asList(GAME_TITLES)));&#x000A;}</code></pre>
          <p>L&#8217;utilisation d&#8217;une méthode d&#8217;assertion séparée nous procure deux bénéfices :</p>
          <ul>
          	<li>cela exprime clairement ce que nous attendons,</li>
          	<li>elle peut être réutilisée pour d&#8217;autres tests.</li>
          </ul>
          <p>Voyons maintenant une nouveauté de JPA 2, l&#8217;API Criteria.</p>
          <h4>Génération du méta-modèle JPA 2</h4>
          <p>Avec l&#8217;API Criteria, vous utiliserez les classes du méta-modèle JPA 2 afin de rester &#8220;type-safe&#8221;. Pour générer ces classes avec Maven, il faut d&#8217;abord dire à Maven d&#8217;utiliser le JDK 6.</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;build&gt;&#x000A;    &lt;plugins&gt;&#x000A;        &lt;plugin&gt;&#x000A;            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;&#x000A;            &lt;version&gt;2.3.2&lt;/version&gt;&#x000A;            &lt;configuration&gt;&#x000A;                &lt;source&gt;1.6&lt;/source&gt;&#x000A;                &lt;target&gt;1.6&lt;/target&gt;&#x000A;            &lt;/configuration&gt;&#x000A;        &lt;/plugin&gt;&#x000A;    &lt;/plugins&gt;&#x000A;&lt;/build&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p>Nous devons aussi configurer Maven pour qu&#8217;il exécute le processeur d&#8217;annotation, simplement en ajoutant le générateur de méta-modèle JPA d&#8217;Hibernate en tant que dépendance pour la compilation uniquement.</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;dependency&gt;&#x000A;    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;&#x000A;    &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;&#x000A;    &lt;version&gt;1.2.0.Final&lt;/version&gt;&#x000A;    &lt;scope&gt;provided&lt;/scope&gt;&#x000A;&lt;/dependency&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p class="info"><span>Le générateur de méta-modèle sera exécuté automatiquement si vous utilisez le compilateur du JDK 6 et que le processeur d&#8217;annotation est dans le classpath.</span></p>
          <p>Avoir la génération du méta-modèle dans Eclipse est un peu plus compliqué. Commencez par créer un fichier nommé .factorypath à la racine du projet et mettez-y la configuration suivante :</p>
          <div class="filename">.factorypath</div>
          <pre class="prettify"><code class="prettify">&lt;factorypath&gt;&#x000A;    &lt;factorypathentry kind="VARJAR" enabled="true" runInBatchMode="false"&#x000A;        id="M2_REPO/org/hibernate/hibernate-jpamodelgen/1.2.0.Final/hibernate-jpamodelgen-1.2.0.Final.jar"/&gt;&#x000A;    &lt;factorypathentry kind="VARJAR" enabled="true" runInBatchMode="false"&#x000A;        id="M2_REPO/org/hibernate/javax/persistence/hibernate-jpa-2.0-api/1.0.0.Final/hibernate-jpa-2.0-api-1.0.0.Final.jar"/&gt;&#x000A;&lt;/factorypath&gt;</code></pre>
          <p>Puis faites un clic droit sur le projet et sélectionnez Properties. Dépliez le noeud Java Compiler dans l&#8217;arbre des paramètres et sélectionnez Annotation Processing. Enfin, changez les valeurs suivantes :</p>
          <ul>
          	<li>cochez &#8220;Enable project specific settings&#8221;,</li>
          	<li>cochez &#8220;Enable annotation processing&#8221;,</li>
          	<li>renseignez &#8220;Generated source directory&#8221; avec &#8220;target/generated-sources/annotations&#8221; (sans les quotes),</li>
          	<li>cliquez sur le bouton Apply et acceptez un build complet,</li>
          	<li>décochez &#8220;Enable annotation processing&#8221;,</li>
          	<li>cliquez sur le bouton Apply, sans le build complet,</li>
          	<li>cochez &#8220;Enable annotation processing&#8221;,</li>
          	<li>cliquez sur le bouton Apply et acceptez un build complet.</li>
          </ul>
          <p>Vous devriez voir le fichier <code>Game_.java</code> dans le répertoire target/generated-sources/annotations , qui devrait être dans le build path.</p>
          <p class="info"><span>Oui, vous devez bidouiller un peu, tout comme vous devez mettre un coup de latte au distributeur automatique de friandises pour qu&#8217;il laisse tomber votre friandise ~:) Si ça vous ennuie, vous pouvez passer l&#8217;étape de génération du méta-modèle et référencer simplement les colonnes avec des chaînes de caractères.</span></p>
          <p>Finalement, vous voilà prêt à écrire la requête Criteria.</p>
          <h4>Requête avec l&#8217;API Critiera</h4>
          <p>Voici une copie du test précédent qui a été modifié pour utiliser l&#8217;API Criteria. Notez que ce test dépend de la génération de la classe de méta-modèle <code>Game_</code> pendant l&#8217;étape de compilation.</p>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import javax.persistence.criteria.CriteriaBuilder;&#x000A;import javax.persistence.criteria.CriteriaQuery;&#x000A;import javax.persistence.criteria.Root;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Test&#x000A;public void shouldFindAllGamesUsingCriteriaApi() throws Exception {&#x000A;    // given&#x000A;    CriteriaBuilder builder = em.getCriteriaBuilder();&#x000A;    CriteriaQuery&lt;Game&gt; criteria = builder.createQuery(Game.class);</code>&#x000A;    		&#x000A;<code class="prettify">    Root&lt;Game&gt; game = criteria.from(Game.class);&#x000A;    criteria.select(game);&#x000A;    // TIP: If you don't want to use the JPA 2 Metamodel,&#x000A;    // you can change the get() method call to get("id")&#x000A;    criteria.orderBy(builder.asc(game.get(Game_.id)));&#x000A;    // No WHERE clause, which implies select all</code>&#x000A;&#x000A;<code class="prettify">    // when&#x000A;    System.out.println("Selecting (using Criteria)...");&#x000A;    List&lt;Game&gt; games = em.createQuery(criteria).getResultList();</code>&#x000A;&#x000A;<code class="prettify">    // then&#x000A;    System.out.println("Found " + games.size() + " games (using Criteria):");&#x000A;    assertContainsAllGames(games);&#x000A;}</code></pre>
          <p>Pour que JPA fonctionne, il a besoin d&#8217;une Persistence Unit.</p>
          <p>Nous définissons la Persistence Unit dans un fichier test-persistence.xml correspondant au conteneur cible. Shrinkwrap récupère ce fichier depuis le classpath et le copie à la position standard dans l’archive.</p>
          <pre class="prettify"><code class="prettify">.addAsResource("test-persistence.xml", "META-INF/persistence.xml")</code></pre>
          <p>Voici la structure de l&#8217;archive que Shrinkwrap va générer pour notre cas de test (sans l&#8217;infrastructure Arquillian) :</p>
          <ul class="filetree">
          	<li>WEB-INF/
          	<ul>
          		<li>beans.xml</li>
          		<li>classes/
          		<ul>
          			<li>META-INF/
          			<ul>
          				<li>persistence.xml</li>
          			</ul></li>
          			<li>org/
          			<ul>
          				<li>arquillian/
          				<ul>
          					<li>example/
          					<ul>
          						<li>Game.class</li>
          						<li>GamePersistenceTestCase.class</li>
          						<li>Game_.class</li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          		</ul></li>
          		<li>lib/
          		<ul>
          			<li>*.jar</li>
          		</ul></li>
          	</ul></li>
          </ul>
          <p>Jetons un coup d&#8217;oeil au descripteur du Persistence Unit que nous utiliserons pour le test, en commençant par celui pour Glassfish embarqué.</p>
          <h3 id="configuration_pour_glassfish">Configuration pour GlassFish</h3>
          <p>Voici le descripteur que nous utiliserons pour Glassfish embarqué.</p>
          <div class="filename">src/test/resources-glassfish-embedded/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="eclipselink.ddl-generation" value="drop-and-create-tables"/&gt;&#x000A;            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;&#x000A;            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>Nous renseignons deux propriétés spécifiques pour activer des fonctionnalités propre sexà EclipseLink, le fournisseur intégré.</p>
          <dl>
          	<dt>eclipselink.ddl-generation</dt>
          	<dd>Configure la commande de génération du schéma de la base ; la valeur drop-and-create-tables indique à EclipseLink de générer la base de données conformément aux entités JPA, à chaque exécution.</dd>
          	<dt>eclipselink.logging.level.sql</dt>
          	<dd>Configure la journalisation des requêtes ; la valeur FINE active les traces des requêtes SQL, nous permettant de suivre l&#8217;activité sur la base de données.</dd>
          </dl>
          <p>Les traces d&#8217;EclipseLink devront aussi être configurées dans le fichier de configuration des logs standards de Java, en y activant le niveau FINE.</p>
          <div class="filename">src/test/resources-glassfish-embedded/logging.properties</div>
          <pre class="prettify"><code class="prettify">handlers=java.util.logging.ConsoleHandler&#x000A;java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter&#x000A;java.util.logging.SimpleFormatter.format=%4$s: %5$s%n&#x000A;java.util.logging.ConsoleHandler.level=FINEST</code></pre>
          <p>L&#8217;unité de persistance dans test-persistence.xml fait référence à une DataSource nommée jdbc/arquillian. Où est-elle définie ? Eh bien, c&#8217;est quelque chose que le conteneur Arquillian doit configurer.</p>
          <p>Nous voulons utiliser l&#8217;API de Glassfish pour créer un pool de connexions JDBC et les ressources associées. Mais nous ne voulons pas le coder. Nous voulons juste le déclarer. C&#8217;est là qu&#8217;Arquillian intervient.</p>
          <p>D&#8217;abord, nous créons un fichier glassfish-resources.xml contenant la définition des ressources, que Glassfish sait consommer.</p>
          <div class="filename">src/test/resources-glassfish-embedded/glassfish-resources.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;!DOCTYPE resources PUBLIC&#x000A;    "-//GlassFish.org//DTD GlassFish Application Server 3.1 Resource Definitions//EN"&#x000A;    "http://glassfish.org/dtds/glassfish-resources_1_5.dtd"&gt;&#x000A;&lt;resources&gt;&#x000A;    &lt;jdbc-resource pool-name="ArquillianEmbeddedDerbyPool"&#x000A;        jndi-name="jdbc/arquillian"/&gt;&#x000A;    &lt;jdbc-connection-pool name="ArquillianEmbeddedDerbyPool"&#x000A;        res-type="javax.sql.DataSource"&#x000A;        datasource-classname="org.apache.derby.jdbc.EmbeddedDataSource"&#x000A;        is-isolation-level-guaranteed="false"&gt;&#x000A;        &lt;property name="databaseName" value="target/databases/derby"/&gt;&#x000A;        &lt;property name="createDatabase" value="create"/&gt;&#x000A;    &lt;/jdbc-connection-pool&gt;&#x000A;&lt;/resources&gt;</code></pre>
          <p>Nous avons ainsi isolé la définition de la DataSource du reste du test de la même façon dont nous avons procédé pour l&#8217;application principale. L&#8217;intérêt supplémentaire est que nous pouvons définir n&#8217;importe quelle ressource dont nous aurions besoin pour notre test. Je vous laisse imaginer les possibilités.</p>
          <p>A présent, nous devons dire à Arquillian d&#8217;utiliser ce fichier. Nous ouvrons la configuration Arquillian et configurons l&#8217;adaptateur du conteneur Glassfish embarqué pour qu&#8217;il prenne ce fichier, avec lequel il alimentera la commande <code>add-resources</code> de l&#8217;API d&#8217;administration de Glassfish.</p>
          <div class="filename">src/test/resources/arquillian.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;arquillian xmlns="http://jboss.org/schema/arquillian"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://jboss.org/schema/arquillian&#x000A;        http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;&#x000A;    &lt;container qualifier="glassfish-embedded" default="true"&gt;&#x000A;        &lt;configuration&gt;&#x000A;            &lt;property name="resourcesXml"&gt;&#x000A;                src/test/resources-glassfish-embedded/glassfish-resources.xml&#x000A;            &lt;/property&gt;&#x000A;        &lt;/configuration&gt;&#x000A;    &lt;/container&gt;&#x000A;&lt;/arquillian&gt;</code></pre>
          <p>A la place de cela, nous pourrions sauter l&#8217;étape de la configuration de la DataSource et simplement inclure les informations de connexion à la base de données directement dans test-persistence.xml, en utilisant les propriétés standard de connexion à la base :</p>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="javax.persistence.jdbc.driver"&#x000A;                value="org.apache.derby.jdbc.EmbeddedDriver"/&gt;&#x000A;            &lt;property name="javax.persistence.jdbc.url"&#x000A;                value="jdbc:derby:target/databases/derby;create=true"/&gt;&#x000A;            &lt;property name="eclipselink.ddl-generation" value="drop-and-create-tables"/&gt;&#x000A;            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;&#x000A;            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>N&#8217;oubliez pas toutefois que le basculement d&#8217;une DataSource JNDI vers une connexion explicite modifie l&#8217;architecture entre l&#8217;environnement de production et celui de test, et ainsi réduit la confiance à accorder aux tests pour identifier toute défaillance potentielle.</p>
          <p>Tout ce qu&#8217;il nous reste à faire, c&#8217;est de configurer l&#8217;adaptateur de conteneur et d&#8217;exécuter le test.</p>
          <h3 id="pr&#233;parer_le_test_pour_glassfish">Préparer le Test pour GlassFish</h3>
          <p>Nous allons séparer les conteneurs cibles en utilisant des profils Maven. Tous les profils vont partager un ensemble de dépendances (comme dans le guide de <a href="guides/getting_started_fr/">Démarrage Rapide</a>) :</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;dependencyManagement&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.arquillian&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;arquillian-bom&lt;/artifactId&gt;&#x000A;            &lt;version&gt;1.0.0.Final&lt;/version&gt;&#x000A;            &lt;scope&gt;import&lt;/scope&gt;&#x000A;            &lt;type&gt;pom&lt;/type&gt;&#x000A;        &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;&lt;/dependencyManagement&gt;&#x000A;&lt;dependencies&gt;&#x000A;    &lt;dependency&gt;&#x000A;        &lt;groupId&gt;junit&lt;/groupId&gt;&#x000A;        &lt;artifactId&gt;junit&lt;/artifactId&gt;&#x000A;        &lt;version&gt;4.10&lt;/version&gt;&#x000A;    &lt;/dependency&gt;&#x000A;    &lt;dependency&gt;&#x000A;        &lt;groupId&gt;org.jboss.arquillian.junit&lt;/groupId&gt;&#x000A;        &lt;artifactId&gt;arquillian-junit-container&lt;/artifactId&gt;&#x000A;        &lt;scope&gt;test&lt;/scope&gt;&#x000A;    &lt;/dependency&gt;&#x000A;&lt;/dependencies&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p class="warning"><span>Si vous prévoyez d&#8217;utiliser une base de données qui n&#8217;est pas incluse dans le serveur d&#8217;applications, comme MySQL, vous devrez inclure ses librairies clientes dans le classpath. Vous pouvez consulter le <a href="http://github.com/arquillian/arquillian-examples/tree/master/arquillian-persistence-tutorial">tutoriel</a> pour avoir un exemple d&#8217;utilisation de H2 à la place de Derby.</span></p>
          <p>A présent, ajoutons (ou modifions) le profil pour Glassfish embarqué.</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;profile&gt;&#x000A;    &lt;id&gt;arquillian-glassfish-embedded&lt;/id&gt;&#x000A;    &lt;activation&gt;&#x000A;        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;&#x000A;    &lt;/activation&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.arquillian.container&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;arquillian-glassfish-embedded-3.1&lt;/artifactId&gt;&#x000A;            &lt;version&gt;1.0.0.CR3&lt;/version&gt;&#x000A;        &lt;/dependency&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.glassfish.main.extras&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;glassfish-embedded-web&lt;/artifactId&gt;&#x000A;            &lt;version&gt;3.1.2&lt;/version&gt;&#x000A;        &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;    &lt;build&gt;&#x000A;        &lt;testResources&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources-glassfish-embedded&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;        &lt;/testResources&gt;&#x000A;        &lt;plugins&gt;&#x000A;            &lt;plugin&gt;&#x000A;                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;&#x000A;                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;&#x000A;                &lt;version&gt;2.12&lt;/version&gt;&#x000A;                &lt;configuration&gt;&#x000A;                    &lt;systemPropertyVariables&gt;&#x000A;                        &lt;java.util.logging.config.file&gt;&#x000A;                            ${project.build.testOutputDirectory}/logging.properties&#x000A;                        &lt;/java.util.logging.config.file&gt;&#x000A;                        &lt;derby.stream.error.file&gt;&#x000A;                            ${project.build.directory}/derby.log&#x000A;                        &lt;/derby.stream.error.file&gt;&#x000A;                    &lt;/systemPropertyVariables&gt;&#x000A;                &lt;/configuration&gt;&#x000A;            &lt;/plugin&gt;&#x000A;        &lt;/plugins&gt;&#x000A;    &lt;/build&gt;&#x000A;&lt;/profile&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p>Nous ajoutons explicitement le répertoire src/test/resources-glassfish-embedded comme une ressource de test afin que le fichier test-persistence.xml soit placé dans le classpath. Nous avons aussi configuré le plugin surefire pour qu&#8217;il passe le fichier de configuration des traces Java au processus en fork afin que le logging SQL fonctionne. Enfin, nous envoyons le fichier le log de Derby dans le répertoire cible du build afin qu&#8217;il soit supprimé lorsqu&#8217;on nettoie le projet.</p>
          <p class="info"><span>Si vous n&#8217;avez pas prévu de tester dans différents conteneurs, vous n&#8217;avez pas besoin de mettre la configuration ci-dessus dans un profil.</span></p>
          <h3 id="ex&#233;cuter_le_test_dans_glassfish">Exécuter le Test dans Glassfish</h3>
          <p>Quand vous avez fini de tout configurer, vous pouvez exécuter le test dans l&#8217;IDE en sélectionnant Run As &gt; JUnit Test ou depuis Maven avec la commande suivante :</p>
          <pre class="command"><code class="command">$ mvn clean test</code></pre>
          <p>Le profil pour Glassfish embarqué est activé par défaut (de même que l&#8217;adaptateur de conteneur dans arquillian.xml). Vous trouverez des extraits de la sortie du test ci-dessous.</p>
          <pre class="output"><code class="output">...&#x000A;Running org.arquillian.example.GamePersistenceTest&#x000A;...&#x000A;INFO: GlassFish Server Open Source Edition 3.1.2 (java_re-private) ...&#x000A;...&#x000A;INFO: command add-resources result: PlainTextActionReporterSUCCESSDescription: add-resources AdminCommandnull&#x000A;    JDBC connection pool ArquillianEmbeddedDerbyPool created successfully.&#x000A;    JDBC resource jdbc/arquillian created successfully.&#x000A;...&#x000A;INFO: WEB0671: Loading application [test] at [/test]&#x000A;...&#x000A;Dumping old records...&#x000A;FINE: DELETE FROM GAME&#x000A;Inserting records...&#x000A;FINE: UPDATE SEQUENCE SET SEQ_COUNT = SEQ_COUNT + ? WHERE SEQ_NAME = ?&#x000A;   bind =&gt; [50, SEQ_GEN]&#x000A;FINE: SELECT SEQ_COUNT FROM SEQUENCE WHERE SEQ_NAME = ?&#x000A;   bind =&gt; [SEQ_GEN]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [3, F-Zero]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [1, Super Mario Brothers]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [2, Mario Kart]&#x000A;Selecting (using JPQL)...&#x000A;FINE: SELECT ID, TITLE FROM GAME ORDER BY ID ASC&#x000A;Found 3 games (using JPQL):&#x000A;* Game@599290122[id = 1; title = Super Mario Brothers]&#x000A;* Game@1550721071[id = 2; title = Mario Kart]&#x000A;* Game@1107500305[id = 3; title = F-Zero]&#x000A;FINE: DELETE FROM GAME&#x000A;Inserting records...&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [5, Mario Kart]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [6, F-Zero]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [4, Super Mario Brothers]&#x000A;Selecting (using Criteria)...&#x000A;FINE: SELECT ID, TITLE FROM GAME ORDER BY ID ASC&#x000A;Found 3 games (using Criteria):&#x000A;* Game@1020493092[id = 4; title = Super Mario Brothers]&#x000A;* Game@1622992302[id = 5; title = Mario Kart]&#x000A;* Game@294335520[id = 6; title = F-Zero]&#x000A;...</code></pre>
          <p><strong>Félicitation !</strong> <strong class="greenbar">Green bar</strong>! <em>Ça c&#8217;est du test d&#8217;intégration !</em></p>
          <p class="important"><span>Lorsque vous introduisez des fonctions de mapping avancées, comme le chargement tardif (ou lazy loading) et les groupes de fetch, vous risquez de tomber sur des erreurs et des alertes causées par Glassfish embarqué et le mode de fonctionnement d&#8217;EclipseLink. Des éléments de configuration supplémentaires sont nécessaires pour contourner ce problème. Vous pouvez consulter le <a href="http://blog.eisele.net/2012/01/arquillian-with-netbeans-glassfish_18.html">blog de Markus Eisele</a> pour les instructions. Vous ne rencontrerez pas ce problème si vous utilisez un adaptateur de conteneur managed ou remote.</span></p>
          <h3 id="ex&#233;cuter_le_test_dans_jboss_as_7">Exécuter le Test dans JBoss AS 7</h3>
          <p>Nous pouvons exécuter exactement le même test dans JBoss AS 7 en faisant quelques petites adaptations du classpath.</p>
          <p>Nous aurons besoin d&#8217;un Persistence Unit différent, qui utilise une DataSource disponible dans JBoss AS et qui positionne quelques paramètres Hibernate.</p>
          <p>Si nous étions dans JBoss AS 7.0, nous aurions besoin de pouvoir <a href="https://docs.jboss.org/author/display/AS7/Admin+Guide#AdminGuide-Datasources">ajouter manuellement une DataSource dans la configuration de JBoss AS</a> ou d&#8217;utiliser la DataSource intégrée, java:jboss/datasources/ExampleDS. Voici le descripteur de la Persistence Unit pour JBoss AS 7.0 qui utilise la DataSource intégrée.</p>
          <div class="filename">src/test/resources-jbossas-managed/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;java:jboss/datasources/ExampleDS&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;&#x000A;            &lt;property name="hibernate.show_sql" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>Les propriétés spécifiques hibernate.hbm2ddl.auto et hibernate.show_sql ont les mêmes fonctions que les propriétés EclipseLink décrites précédemment.</p>
          <p>Si vous utilisez JBoss AS 7.1, comme nous le recommandons, vous pouvez déclarer dynamiquement une nouvelle DataSource en ajoutant un descripteur (i.e. un fichier avec l&#8217;extension -ds.xml), contenant une ou plusieurs définitions de DataSources, au répertoire META-INF d&#8217;une archive Java ou au répertoire WEB-INF d&#8217;une archive Web.</p>
          <p>Voici un déscripteur qui définit une DataSource H2 avec le nom JNDI jdbc/arquillian (le même nom JNDI que la DataSource que nous avons définie précédemment pour Glassfish):</p>
          <div class="filename">src/test/resources/jbossas-ds.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;datasources xmlns="http://www.jboss.org/ironjacamar/schema"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://www.jboss.org/ironjacamar/schema&#x000A;        http://docs.jboss.org/ironjacamar/schema/datasources_1_0.xsd"&gt;&#x000A;    &lt;datasource enabled="true"&#x000A;        jndi-name="jdbc/arquillian"&#x000A;        pool-name="ArquillianEmbeddedH2Pool"&gt;&#x000A;        &lt;connection-url&gt;jdbc:h2:mem:arquillian;DB_CLOSE_DELAY=-1&lt;/connection-url&gt;&#x000A;        &lt;driver&gt;h2&lt;/driver&gt;&#x000A;    &lt;/datasource&gt;&#x000A;&lt;/datasources&gt;</code></pre>
          <p class="info"><span>JBoss AS 7.1 supporte nativement la base de données H2. Pour utiliser une autre base de données, vous devez ajouter le driver correspondant à l&#8217;installation, tel que c&#8217;est décrit dans le <a href="https://docs.jboss.org/author/display/AS71/Admin+Guide#AdminGuide-Datasources">chapitre sur les DataSource du guide de référence JBoss AS 7.1</a>.</span></p>
          <p>Nous devons mettre à jour notre Persistence Unit pour référencer cette nouvelle DataSource :</p>
          <div class="filename">src/test/resources-jbossas-managed/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;&#x000A;            &lt;property name="hibernate.show_sql" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
          <p>Nous devons aussi ajouter le descripteur au répertoire WEB-INF de l&#8217;archive de test. Ajoutez cet appel de méthode au builder ShrinkWrap dans la méthode <code>@Deployment</code> du cas de test :</p>
          <pre class="prettify"><code class="prettify">.addAsWebInfResource("jbossas-ds.xml")</code></pre>
          <p>Inclure ce fichier dans l&#8217;archive n&#8217;a pas d&#8217;impact sur la capacité à exécuter le test dans Glassfish embarqué. La DataSource et la Persistence Unit sont prêtes à l&#8217;emploi.</p>
          <p>Maintenant nous avons besoin d&#8217;un profil Maven qui ajoute le conteneur JBoss AS, ainsi que les ressources JBoss AS dans le classpath :</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;profile&gt;&#x000A;    &lt;id&gt;arquillian-jbossas-managed&lt;/id&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;jboss-as-arquillian-container-managed&lt;/artifactId&gt;&#x000A;            &lt;version&gt;7.1.1.Final&lt;/version&gt;&#x000A;            &lt;scope&gt;test&lt;/scope&gt;&#x000A;        &lt;/dependency&gt;&#x000A;         &lt;dependency&gt;&#x000A;             &lt;groupId&gt;org.jboss.spec&lt;/groupId&gt;&#x000A;             &lt;artifactId&gt;jboss-javaee-web-6.0&lt;/artifactId&gt;&#x000A;             &lt;version&gt;3.0.0.Final&lt;/version&gt;&#x000A;             &lt;type&gt;pom&lt;/type&gt;&#x000A;             &lt;scope&gt;provided&lt;/scope&gt;&#x000A;             &lt;exclusions&gt;&#x000A;                 &lt;exclusion&gt;&#x000A;                     &lt;groupId&gt;xalan&lt;/groupId&gt;&#x000A;                     &lt;artifactId&gt;xalan&lt;/artifactId&gt;&#x000A;                 &lt;/exclusion&gt;&#x000A;             &lt;/exclusions&gt;&#x000A;         &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;    &lt;build&gt;&#x000A;        &lt;testResources&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources-jbossas-managed&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;        &lt;/testResources&gt;&#x000A;    &lt;/build&gt;&#x000A;&lt;/profile&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
          <p>Maintenant, nous exécutons à nouveau le test avec Maven, mais cette fois-ci nous activons le profil JBoss AS managed.</p>
          <pre class="command"><code class="command">$ mvn clean test -Parquillian-jbossas-managed</code></pre>
          <p class="warning"><span>Assurez-vous que la variable d&#8217;environnement JBOSS_HOME pointe vers une installation JBoss AS 7.1.1.Final. Sinon, vous pouvez définir la localisation en utilisant la propriété jbossHome dans arquillian.xml.</span></p>
          <p>Vous pouvez exécuter ce test depuis votre IDE ! Importez juste votre projet, activez le profil Maven arquillian-jbossas-managed (et désactivez arquillian-glassfish-embedded), ouvrez le cas de test et sélectionnez &#8220;Run As &gt; JUnit Test&#8221;. Voila ! Ça marche comme n&#8217;importe quel autre test unitaire. <strong class="greenbar">Green bar</strong>!</p>
          <p><strong>Appréciez la recette idéale pour tester JPA !</strong></p>
          <p class="info"><span>Même si la préparation peut sembler longue, reconnaissez que nous avons fait le tour de la question. Pour vous en remémorer les avantages, regardez juste la simplicité du cas de test, et rappelez-vous qu&#8217;il n&#8217;est lié à aucun conteneur Java EE 6 ou implémentation JPA 2 spécifiques.</span></p>
          <h3 id="share">Share the Knowledge</h3>
          <p>Find this guide useful?</p>
          <p class="post_to_twitter"><a href="http://twitter.com/home/?status=Just%20read%20the%20%23Arquillian%20Tester%20la%20persistance%20Java%20guide%20and%20got%20a%20%23greenbar!%20Get%20yours.%20http://arquillian.org/guides/testing_java_persistence_fr/"><img src="/images/post_to_twitter.png" alt="" /></a></p>
          <div class="g-plusone" data-size="tall"></div>
          <p>There&#8217;s a lot more about Arquillian to cover. If you&#8217;re ready to learn more, check out the <a href="/guides">other available guides</a>.</p>
          <h4>Feedback</h4>
          <p>Find a bug in the guide? Something missing? You can fix it by <a href="http://github.com/arquillian/arquillian.github.com">forking this website</a>, making the correction and <a href="http://help.github.com/send-pull-requests">sending a pull request</a>. If you&#8217;re just plain stuck, feel free to ask a question in the <a href="http://community.jboss.org/en/arquillian?view=discussions">user discussion forum</a>.</p>
          <h4>Recent Changelog</h4>
          <ul>
            <li>
              Mar 22, 2017:
              Adds documentation link in the module details
              <em>by Bartosz Majsak</em>
            </li>
          </ul>
          <p>
            <a href="https://github.com/arquillian/arquillian.github.io/commits/develop/guides/testing_java_persistence_fr.textile">See full history &raquo;</a>
          </p>
        </div>
        <div id="sidebar">
          <div id="toc">
            <h3 class="chapter_header">Chapters</h3>
            <ol class="chapters">
              <li>
                <a href="#hypoth&#232;ses" id="hypothèses_link">Hypothèses</a>
              </li>
              <li>
                <a href="#objectif" id="objectif_link">Objectif</a>
              </li>
              <li>
                <a href="#structure_du_projet" id="structure_du_projet_link">Structure du Projet</a>
              </li>
              <li>
                <a href="#ecrire_le_test" id="ecrire_le_test_link">Ecrire le Test</a>
              </li>
              <li>
                <a href="#configuration_pour_glassfish" id="configuration_pour_glassfish_link">Configuration pour GlassFish</a>
              </li>
              <li>
                <a href="#pr&#233;parer_le_test_pour_glassfish" id="préparer_le_test_pour_glassfish_link">Préparer le Test pour GlassFish</a>
              </li>
              <li>
                <a href="#ex&#233;cuter_le_test_dans_glassfish" id="exécuter_le_test_dans_glassfish_link">Exécuter le Test dans Glassfish</a>
              </li>
              <li>
                <a href="#ex&#233;cuter_le_test_dans_jboss_as_7" id="exécuter_le_test_dans_jboss_as_7_link">Exécuter le Test dans JBoss AS 7</a>
              </li>
              <li>
                <a href="#share" id="share_link">Share the Knowledge</a>
              </li>
            </ol>
          </div>
        </div>
        <script>
          $(window).load(function() { activateScrollingToc(['hypothèses', 'objectif', 'structure_du_projet', 'ecrire_le_test', 'configuration_pour_glassfish', 'préparer_le_test_pour_glassfish', 'exécuter_le_test_dans_glassfish', 'exécuter_le_test_dans_jboss_as_7', 'share']) })
        </script>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="project">
          <img src="/images/arquillian_logo_200px.png" />
          <p class="bottom">
            &#169;
            Copyright 2009-2017 Red Hat, Inc.
            <br />
            <i class="icon-fire"></i>
            Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.
            <br />
            <i class="icon-share-alt"></i>
            Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
            <br />
            Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>.
          </p>
        </div>
        <div class="footer-nav">
          <h4>Learn</h4>
          <ul>
            <li>
              <a href="/invasion">Mission</a>
            </li>
            <li>
              <a href="/features">Features</a>
            </li>
            <li>
              <a href="/docs">Documentation</a>
            </li>
            <li>
              <a href="/guides">Guides</a>
            </li>
            <li>
              <a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Manual</a>
            </li>
            <li>
              <a href="http://community.jboss.org/en/arquillian/faq">FAQs</a>
            </li>
          </ul>
        </div>
        <div class="footer-nav">
          <h4>Get Involved</h4>
          <ul>
            <li>
              <a href="http://community.jboss.org/en/arquillian?view=discussions">Forums</a>
            </li>
            <li>
              <a href="https://issues.jboss.org/browse/ARQ">Issue Tracker</a>
            </li>
            <li>
              <a href="https://github.com/arquillian">Source Code</a>
            </li>
            <li>
              <a href="/community/contributors">Contributors</a>
            </li>
            <li>
              <a href="https://community.jboss.org/groups/testing">Testing SIG</a>
            </li>
          </ul>
        </div>
        <div class="sponser">
          <div class="follow-us">
            <h4>Stay Informed</h4>
            <ul>
              <li>
                <a href="https://plus.google.com/100660127586085393031?rel=author"><img alt="Google+" src="/images/social/googleplus-16.png" title="Follow Arquillian on Google+" /></a>
              </li>
              <li>
                <a href="https://twitter.com/#!/search/%23arquillian"><img alt="Twitter" src="/images/social/twitter-16.png" title="Browse the #arquillian hashtag on Twitter" /></a>
              </li>
              <li>
                <a href="http://www.linkedin.com/groups?gid=3120340"><img alt="LinkedIn" src="/images/social/linkedin-16.png" title="Join the Arquillian group on LinkedIn" /></a>
              </li>
              <li>
                <a href="http://vimeo.com/channels/arquillian"><img alt="Vimeo" src="/images/social/vimeo-16.png" title="Follow the Arquillian channel on Vimeo" /></a>
              </li>
            </ul>
          </div>
          <p>This website is open source! If you want to improve it, <a href="http://github.com/arquillian/arquillian.github.com">fork the project</a>, hack on it, then send a <a href="https://help.github.com/articles/using-pull-requests">pull request</a>. You can also view the <a href="http://www.seethestats.com/site/arquillian.org">visitor stats</a>.</p>
          <p class="image"><a href="http://jboss.org"><img src="/images/jboss_redhat_branding.png" class="branding" title="Red Hat, Inc." alt="Red Hat, Inc." /></a></p>
          <p>Arquillian is a <a href="http://jboss.org">JBoss Community</a> project and development is sponsored by Red Hat, Inc.</p>
          <p class="bottom"><a href="http://www.redhat.com/legal/legal_statement.html">Terms of Use</a> | <a href="http://www.redhat.com/legal/privacy_statement.html">Privacy Policy</a></p>
        </div>
        <a class="visible-desktop" href="#" id="toTop">Top</a>
      </div>
    </footer>
    <script>
      $(function() {
        $('html').addClass('ready');
        prettify();
        activateFooterGravity();
        activateTooltips();
        activateToTopControl();
      });
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.0.2/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>
    <script src="/javascripts/site.js?2685dacf30d367d2e6297e86462db3706390ff4d"></script>
    <script src="/javascripts/jquery-scroll.js"></script>
    <script src="http://apis.google.com/js/plusone.js"></script>
    <script>
      (function() {
        var po = document.createElement('script'); po.async = true; po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount','UA-18727998-3']);
    _gaq.push(['_trackPageview']);
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </body>
</html>
